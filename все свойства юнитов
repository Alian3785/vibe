# ============================================================
# –ë–õ–û–ö 1: –ö–ê–°–¢–û–ú–ù–ê–Ø –°–†–ï–î–ê Gymnasium ¬´RED vs BLUE¬ª
# ------------------------------------------------------------
# –¢–∏–ø—ã:
#  ‚Ä¢ Archer ‚Äî –æ–¥–∏–Ω–æ—á–Ω–∞—è –∞—Ç–∞–∫–∞ (—É—Ä–æ–Ω 20)
#  ‚Ä¢ gargoil ‚Äî (–±—ã–≤—à–∏–π earth-–ª—É—á–Ω–∏–∫) –æ–¥–∏–Ω–æ—á–Ω–∞—è –∞—Ç–∞–∫–∞, –±–∞–∑–æ–≤—ã–µ —Å—Ç–∞—Ç—ã –∫–∞–∫ —É Archer, –Ω–æ –±—Ä–æ–Ω—è=65
#  ‚Ä¢ Death  ‚Äî –æ–¥–∏–Ω–æ—á–Ω–∞—è –∞—Ç–∞–∫–∞ + –ø—Ä–∏ –ü–ï–†–í–û–ú –ø–æ–ø–∞–¥–∞–Ω–∏–∏ –Ω–∞–∫–ª–∞–¥—ã–≤–∞–µ—Ç —è–¥ (—É—Ä–æ–Ω = "—É—Ä–æ–Ω2" –∫–∞–∂–¥–æ–µ –Ω–∞—á–∞–ª–æ —Ö–æ–¥–∞, 3 —Ç–∏–∫–∞)
#             + –∏–º–º—É–Ω–∏—Ç–µ—Ç –∫ "Weapon"; –¢–∏–ø –∞—Ç–∞–∫–∏ 2: "poison"
#  ‚Ä¢ Mage   ‚Äî –º–∞—Å—Å–æ–≤–∞—è –∞—Ç–∞–∫–∞ –ø–æ –≤—Å–µ–º –∂–∏–≤—ã–º –≤—Ä–∞–≥–∞–º
#  ‚Ä¢ –í–æ–∏–Ω   ‚Äî –±–ª–∏–∂–Ω–∏–π –±–æ–π —Å–æ —Å–º–µ–∂–Ω–æ—Å—Ç—å—é
#  ‚Ä¢ Demon  ‚Äî –∫–∞–∫ –í–æ–∏–Ω –ø–æ –¥–æ—Å—è–≥–∞–µ–º–æ—Å—Ç–∏, –Ω–æ –±—å—ë—Ç –î–í–ê–ñ–î–´
#  ‚Ä¢ lord   ‚Äî –∫–∞–∫ –í–æ–∏–Ω; –ø–µ—Ä–≤–∞—è –µ–≥–æ —É—Å–ø–µ—à–Ω–∞—è –∞—Ç–∞–∫–∞ –Ω–∞–∫–ª–∞–¥—ã–≤–∞–µ—Ç ¬´–ø–æ–¥–∂–æ–≥¬ª (10 —É—Ä–æ–Ω–∞ √ó 3 —Ç–∏–∫–∞). –¢–∏–ø –∞—Ç–∞–∫–∏ 2: "Fire"
#  ‚Ä¢ Dead dragon ‚Äî –±—å—ë—Ç –∫–∞–∫ Mage (–º–∞—Å—Å–æ–≤–∞—è –∞—Ç–∞–∫–∞), –¢–∏–ø –∞—Ç–∞–∫–∏ 1 = "death";
#                   –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é 40% –æ—Ç—Ä–∞–≤–ª—è–µ—Ç –∫–∞–∂–¥–æ–≥–æ –ø–æ—Ä–∞–∂—ë–Ω–Ω–æ–≥–æ (–¢–∏–ø –∞—Ç–∞–∫–∏ 2 = "poison"),
#                   –æ—Ç—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞–Ω–æ—Å–∏—Ç —É—Ä–æ–Ω = "—É—Ä–æ–Ω2" —Ü–µ–ª–∏ –∫–∞–∂–¥—ã–π —Ç–∏–∫.
#
# –ù–æ–≤—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞ —é–Ω–∏—Ç–∞:
#  ‚Ä¢ "–±—Ä–æ–Ω—è" (0..100). –í–•–û–î–Ø–©–ò–ô —É—Ä–æ–Ω —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è: dmg √ó (1 - –±—Ä–æ–Ω—è/100).
#  ‚Ä¢ "–¢–æ—á–Ω–æ—Å—Ç—å" (0..100). –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ø–æ–ø–∞–¥–∞–Ω–∏—è; –ø—Ä–∏ –ø—Ä–æ–º–∞—Ö–µ —É—Ä–æ–Ω = 0 –∏ —Å—Ç–∞—Ç—É—Å—ã –Ω–µ –Ω–∞–∫–ª–∞–¥—ã–≤–∞—é—Ç—Å—è.
#  ‚Ä¢ "—É—Ä–æ–Ω2" (‚â•0). –£—Ä–æ–Ω —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ —Å—Ç–∞—Ç—É—Å–∞ (—è–¥); –¥–ª—è Death –∏ Dead dragon = 20, —É –æ—Å—Ç–∞–ª—å–Ω—ã—Ö = 0.
#
# –°–≤–æ–π—Å—Ç–≤–∞ —é–Ω–∏—Ç–∞ (–≤—Å–µ, –∫—Ä–æ–º–µ –∏–º–µ–Ω–∏, –ø–æ–ø–∞–¥–∞—é—Ç –≤ –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞):
#  ‚Ä¢ "–ó–¥–æ—Ä–æ–≤—å–µ" (HP), "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞", "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞_–±–∞–∑–∞", "–£—Ä–æ–Ω", "—É—Ä–æ–Ω2"
#  ‚Ä¢ "team" (red/blue), "position" (1..12), "stand" (ahead/behind), "Type"
#  ‚Ä¢ "–∏–º–º—É–Ω–∏—Ç–µ—Ç": list[str] ‚Äî —Å–ø–∏—Å–æ–∫ –∏–º–º—É–Ω–∏—Ç–µ—Ç–æ–≤ –∫ —Ç–∏–ø–∞–º –∞—Ç–∞–∫–∏ ("Weapon","earth","Fire","poison","death"...)
#  ‚Ä¢ "–¢–∏–ø –∞—Ç–∞–∫–∏ 1": str     ‚Äî –±–∞–∑–æ–≤—ã–π —Ç–∏–ø –∞—Ç–∞–∫–∏ (–∏–º–º—É–Ω–∏—Ç–µ—Ç –±–ª–æ–∫–∏—Ä—É–µ—Ç —É—Ä–æ–Ω + —ç—Ñ—Ñ–µ–∫—Ç—ã)
#  ‚Ä¢ "–¢–∏–ø –∞—Ç–∞–∫–∏ 2": str     ‚Äî –¥–æ–ø. —Ç–∏–ø –¥–ª—è –∏–º–º—É–Ω–∏—Ç–µ—Ç–∞ –∫ –ù–ê–õ–û–ñ–ï–ù–ò–Æ —Å—Ç–∞—Ç—É—Å–∞ (—è–¥/–ø–æ–¥–∂–æ–≥)
#  ‚Ä¢ "poison_turns_left": int ‚Äî –æ—Å—Ç–∞–≤—à–∏–µ—Å—è —Ç–∏–∫–∏ —è–¥–∞
#  ‚Ä¢ "poison_damage_per_tick": int ‚Äî —É—Ä–æ–Ω —è–¥–∞ –∑–∞ —Ç–∏–∫ (—Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –Ω–∞–ª–æ–∂–µ–Ω–∏–∏)
#  ‚Ä¢ "burn_turns_left":   int ‚Äî –æ—Å—Ç–∞–≤—à–∏–µ—Å—è —Ç–∏–∫–∏ –ø–æ–¥–∂–æ–≥–∞
# ------------------------------------------------------------
# –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: —è—á–µ–π–∫–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç Stable-Baselines3 –∏ Weights & Biases.
# ============================================================

# (–ö–æ–ª–∞–±) –ú—è–≥–∫–æ —É–±–µ–¥–∏–º—Å—è, —á—Ç–æ Gymnasium —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.
try:
    import gymnasium as gym
except Exception:
    # noqa
    !pip -q install gymnasium
    import gymnasium as gym

import random
from operator import itemgetter
from typing import List, Dict, Optional

import numpy as np
from gymnasium import spaces

# --- —Å–ª–æ–≤–∞—Ä–∏ –¥–ª—è –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –Ω–∞–±–ª—é–¥–µ–Ω–∏–∏ ---
TYPE_LIST = ["Archer", "gargoil", "Mage", "–í–æ–∏–Ω", "Demon", "Death", "lord", "Dead dragon"]  # one-hot(8)
ATTACK_TYPES = ["Weapon", "earth", "Fire", "poison", "death"]                                # one-hot(5)

def _one_hot(value: str, vocab: List[str]) -> List[float]:
    return [1.0 if value == v else 0.0 for v in vocab]

def _multi_hot(values: List[str], vocab: List[str]) -> List[float]:
    s = set(values or [])
    return [1.0 if v in s else 0.0 for v in vocab]

# ------------------------ –ò—Å—Ö–æ–¥–Ω—ã–µ —é–Ω–∏—Ç—ã (–û–ë–ù–û–í–õ–Å–ù–ù–´–ï) ------------------------
# RED (–≤–ø–µ—Ä—ë–¥): —Å–∫–µ–ª–µ—Ç-—Ä—ã—Ü–∞—Ä—å (pos=1), —Ä—ã—Ü–∞—Ä—å —Å–º–µ—Ä—Ç–∏ (pos=2), –ú—ë—Ä—Ç–≤—ã–π –¥—Ä–∞–∫–æ–Ω (pos=3)
# RED (—Ç—ã–ª):    –ê—Ä—Ö–∏–ª–∏—á (pos=4), –°–º–µ—Ä—Ç—å1 (pos=5), pos=6 ‚Äî –ø—É—Å—Ç–æ
# BLUE (–∑–∞–¥–Ω–∏–π —Ä—è–¥ –ø—É—Å—Ç): –ê—Å—Ç–µ—Ä–æ—Ç (Demon) pos=7, –ì–µ—Ä—Ü–æ–≥ (–í–æ–∏–Ω) pos=8, –ì–∞—Ä–≥—É–ª—å—è (earth, immune poison) pos=9

# RED
UNITS_RED = [
    {"–∏–º—è": "—Å–∫–µ–ª–µ—Ç-—Ä—ã—Ü–∞—Ä—å",  "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞": 50, "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞_–±–∞–∑–∞": 50, "team": "red",  "position": 1, "stand": "ahead",
     "Type": "–í–æ–∏–Ω", "–£—Ä–æ–Ω": 100, "—É—Ä–æ–Ω2": 0, "–ó–¥–æ—Ä–æ–≤—å–µ": 270, "–±—Ä–æ–Ω—è": 0, "–¢–æ—á–Ω–æ—Å—Ç—å": 80, "–∏–º–º—É–Ω–∏—Ç–µ—Ç": [], "–¢–∏–ø –∞—Ç–∞–∫–∏ 1": "Weapon", "–¢–∏–ø –∞—Ç–∞–∫–∏ 2": ""},

    {"–∏–º—è": "—Ä—ã—Ü–∞—Ä—å —Å–º–µ—Ä—Ç–∏",  "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞": 50, "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞_–±–∞–∑–∞": 50, "team": "red",  "position": 2, "stand": "ahead",
     "Type": "–í–æ–∏–Ω", "–£—Ä–æ–Ω": 120, "—É—Ä–æ–Ω2": 0, "–ó–¥–æ—Ä–æ–≤—å–µ": 255, "–±—Ä–æ–Ω—è": 0, "–¢–æ—á–Ω–æ—Å—Ç—å": 87, "–∏–º–º—É–Ω–∏—Ç–µ—Ç": [], "–¢–∏–ø –∞—Ç–∞–∫–∏ 1": "Weapon", "–¢–∏–ø –∞—Ç–∞–∫–∏ 2": ""},

    {"–∏–º—è": "–ú–µ—Ä—Ç–≤—ã–π –¥—Ä–∞–∫–æ–Ω", "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞": 35, "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞_–±–∞–∑–∞": 35, "team": "red", "position": 3, "stand": "ahead",
     "Type": "Dead dragon", "–£—Ä–æ–Ω": 65, "—É—Ä–æ–Ω2": 20, "–ó–¥–æ—Ä–æ–≤—å–µ": 450, "–±—Ä–æ–Ω—è": 0, "–¢–æ—á–Ω–æ—Å—Ç—å": 80, "–∏–º–º—É–Ω–∏—Ç–µ—Ç": [], "–¢–∏–ø –∞—Ç–∞–∫–∏ 1": "death", "–¢–∏–ø –∞—Ç–∞–∫–∏ 2": "poison"},

    {"–∏–º—è": "–ê—Ä—Ö–∏–ª–∏—á", "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞": 40, "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞_–±–∞–∑–∞": 40, "team": "red", "position": 4, "stand": "behind",
     "Type": "Mage", "–£—Ä–æ–Ω": 90, "—É—Ä–æ–Ω2": 0, "–ó–¥–æ—Ä–æ–≤—å–µ": 170, "–±—Ä–æ–Ω—è": 0, "–¢–æ—á–Ω–æ—Å—Ç—å": 80, "–∏–º–º—É–Ω–∏—Ç–µ—Ç": [], "–¢–∏–ø –∞—Ç–∞–∫–∏ 1": "earth", "–¢–∏–ø –∞—Ç–∞–∫–∏ 2": ""},

    {"–∏–º—è": "–°–º–µ—Ä—Ç—å1", "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞": 40, "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞_–±–∞–∑–∞": 40, "team": "red", "position": 5, "stand": "behind",
     "Type": "Death", "–£—Ä–æ–Ω": 100, "—É—Ä–æ–Ω2": 20, "–ó–¥–æ—Ä–æ–≤—å–µ": 125, "–±—Ä–æ–Ω—è": 0, "–¢–æ—á–Ω–æ—Å—Ç—å": 80, "–∏–º–º—É–Ω–∏—Ç–µ—Ç": ["Weapon"], "–¢–∏–ø –∞—Ç–∞–∫–∏ 1": "Weapon", "–¢–∏–ø –∞—Ç–∞–∫–∏ 2": "poison"},

    {"–∏–º—è": "–ø—É—Å—Ç–æ", "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞": 0, "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞_–±–∞–∑–∞": 0, "team": "red", "position": 6, "stand": "behind",
     "Type": "Archer", "–£—Ä–æ–Ω": 0, "—É—Ä–æ–Ω2": 0, "–ó–¥–æ—Ä–æ–≤—å–µ": 0, "–±—Ä–æ–Ω—è": 0, "–¢–æ—á–Ω–æ—Å—Ç—å": 0, "–∏–º–º—É–Ω–∏—Ç–µ—Ç": [], "–¢–∏–ø –∞—Ç–∞–∫–∏ 1": "Weapon", "–¢–∏–ø –∞—Ç–∞–∫–∏ 2": ""},
]

# BLUE (–∑–∞–¥–Ω–∏–π —Ä—è–¥ –ø—É—Å—Ç, pos=9 ‚Äî gargoil earth + –∏–º–º—É–Ω–∏—Ç–µ—Ç –∫ poison)
UNITS_BLUE = [
    {"–∏–º—è": "–ê—Å—Ç–µ—Ä–æ—Ç",   "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞": 50, "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞_–±–∞–∑–∞": 50, "team": "blue", "position": 7,  "stand": "ahead",
     "Type": "Demon","–£—Ä–æ–Ω": 150, "—É—Ä–æ–Ω2": 0, "–ó–¥–æ—Ä–æ–≤—å–µ": 1020,  "–±—Ä–æ–Ω—è": 0, "–¢–æ—á–Ω–æ—Å—Ç—å": 80, "–∏–º–º—É–Ω–∏—Ç–µ—Ç": [], "–¢–∏–ø –∞—Ç–∞–∫–∏ 1": "Weapon", "–¢–∏–ø –∞—Ç–∞–∫–∏ 2": ""},

    {"–∏–º—è": "–ì–µ—Ä—Ü–æ–≥",  "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞": 50, "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞_–±–∞–∑–∞": 50, "team": "blue", "position": 8,  "stand": "ahead",
     "Type": "–í–æ–∏–Ω", "–£—Ä–æ–Ω": 120, "—É—Ä–æ–Ω2": 0, "–ó–¥–æ—Ä–æ–≤—å–µ": 306,  "–±—Ä–æ–Ω—è": 0, "–¢–æ—á–Ω–æ—Å—Ç—å": 100, "–∏–º–º—É–Ω–∏—Ç–µ—Ç": [], "–¢–∏–ø –∞—Ç–∞–∫–∏ 1": "Weapon", "–¢–∏–ø –∞—Ç–∞–∫–∏ 2": ""},

    {"–∏–º—è": "–ì–∞—Ä–≥—É–ª—å—è", "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞": 60, "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞_–±–∞–∑–∞": 60, "team": "blue", "position": 9,  "stand": "ahead",
     "Type": "gargoil","–£—Ä–æ–Ω": 85, "—É—Ä–æ–Ω2": 0, "–ó–¥–æ—Ä–æ–≤—å–µ": 170,  "–±—Ä–æ–Ω—è": 65, "–¢–æ—á–Ω–æ—Å—Ç—å": 80, "–∏–º–º—É–Ω–∏—Ç–µ—Ç": ["poison"], "–¢–∏–ø –∞—Ç–∞–∫–∏ 1": "earth", "–¢–∏–ø –∞—Ç–∞–∫–∏ 2": ""},

    {"–∏–º—è": "–ø—É—Å—Ç–æ",    "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞": 0,  "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞_–±–∞–∑–∞": 0,  "team": "blue", "position": 10, "stand": "behind",
     "Type": "Archer","–£—Ä–æ–Ω": 0,  "—É—Ä–æ–Ω2": 0, "–ó–¥–æ—Ä–æ–≤—å–µ": 0,   "–±—Ä–æ–Ω—è": 0,  "–¢–æ—á–Ω–æ—Å—Ç—å": 0, "–∏–º–º—É–Ω–∏—Ç–µ—Ç": [], "–¢–∏–ø –∞—Ç–∞–∫–∏ 1": "Weapon", "–¢–∏–ø –∞—Ç–∞–∫–∏ 2": ""},

    {"–∏–º—è": "–ø—É—Å—Ç–æ",    "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞": 0,  "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞_–±–∞–∑–∞": 0,  "team": "blue", "position": 11, "stand": "behind",
     "Type": "Archer","–£—Ä–æ–Ω": 0,  "—É—Ä–æ–Ω2": 0, "–ó–¥–æ—Ä–æ–≤—å–µ": 0,   "–±—Ä–æ–Ω—è": 0,  "–¢–æ—á–Ω–æ—Å—Ç—å": 0, "–∏–º–º—É–Ω–∏—Ç–µ—Ç": [], "–¢–∏–ø –∞—Ç–∞–∫–∏ 1": "Weapon", "–¢–∏–ø –∞—Ç–∞–∫–∏ 2": ""},

    {"–∏–º—è": "–ø—É—Å—Ç–æ",    "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞": 0,  "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞_–±–∞–∑–∞": 0,  "team": "blue", "position": 12, "stand": "behind",
     "Type": "Archer","–£—Ä–æ–Ω": 0,  "—É—Ä–æ–Ω2": 0, "–ó–¥–æ—Ä–æ–≤—å–µ": 0,   "–±—Ä–æ–Ω—è": 0,  "–¢–æ—á–Ω–æ—Å—Ç—å": 0, "–∏–º–º—É–Ω–∏—Ç–µ—Ç": [], "–¢–∏–ø –∞—Ç–∞–∫–∏ 1": "Weapon", "–¢–∏–ø –∞—Ç–∞–∫–∏ 2": ""},
]

# –î–∏–∞–ø–∞–∑–æ–Ω—ã –ø–æ–∑–∏—Ü–∏–π
RED_POSITIONS:  List[int] = list(range(1, 7))
BLUE_POSITIONS: List[int] = list(range(7, 13))

# –ú–∞–∫—Å–∏–º—É–º—ã HP –ø–æ —Ç–∏–ø–∞–º ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –±–∞–∑–æ–≤—ã–π –º–∞–∫—Å–∏–º—É–º –¥–ª—è —à–∫–∞–ª (–≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è)
HP_MAX_BY_TYPE = {
    "Archer": 60,
    "gargoil": 60,
    "Death": 60,
    "Mage": 170,
    "–í–æ–∏–Ω": 306,
    "Demon": 1020,
    "lord": 80,
    "Dead dragon": 450,
}

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è –Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞–±–ª—é–¥–µ–Ω–∏–π
MAX_HP   = max([u["–ó–¥–æ—Ä–æ–≤—å–µ"] for u in (UNITS_RED + UNITS_BLUE)])   # 1020
MAX_INIT = max([u["–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞_–±–∞–∑–∞"] for u in (UNITS_RED + UNITS_BLUE)])
MAX_DMG  = max([u["–£—Ä–æ–Ω"] for u in (UNITS_RED + UNITS_BLUE)])
MAX_DMG2 = max([u["—É—Ä–æ–Ω2"] for u in (UNITS_RED + UNITS_BLUE)])

POISON_TURNS  = 3
BURN_DAMAGE = 10
BURN_TURNS  = 3

# ------------------------ –ö–∞—Å—Ç–æ–º–Ω–∞—è —Å—Ä–µ–¥–∞ ------------------------
class BattleEnv(gym.Env):
    """
    –°—Ä–µ–¥–∞ RED vs BLUE –¥–ª—è RL.

    –ù–∞–±–ª—é–¥–µ–Ω–∏–µ (obs): –≤–µ–∫—Ç–æ—Ä (12 —é–Ω–∏—Ç–æ–≤ √ó 35 –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ = 420):
      –î–ª—è –ö–ê–ñ–î–û–ì–û —Å–ª–æ—Ç–∞ (–≤ –ø–æ—Ä—è–¥–∫–µ pos=1..12) –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è 35 —á–∏—Å–µ–ª:
        1)  HP               ‚àà [0, MAX_HP]
        2)  INI              ‚àà [0, MAX_INIT]
        3)  INI_base         ‚àà [0, MAX_INIT]
        4)  DMG              ‚àà [0, MAX_DMG]
        5)  DMG2             ‚àà [0, MAX_DMG2]
        6)  team             ‚àà {0(red),1(blue)}
        7)  pos              ‚àà [1,12]
        8)  stand            ‚àà {0(ahead),1(behind)}
        9-16)  TYPE one-hot  ‚àà {Archer,gargoil,Mage,–í–æ–∏–Ω,Demon,Death,lord,Dead dragon} (8)
        17-21) IMM multi-hot ‚àà {Weapon,earth,Fire,poison,death} (5)
        22-26) ATK1 one-hot  ‚àà {Weapon,earth,Fire,poison,death} (5)
        27-31) ATK2 one-hot  ‚àà {Weapon,earth,Fire,poison,death} (5) (–≤—Å–µ –Ω—É–ª–∏ = –ø—É—Å—Ç–æ)
        32) armor            ‚àà [0,100]
        33) accuracy         ‚àà [0,100]
        34) poison_turns_left ‚àà [0, POISON_TURNS]
        35) burn_turns_left   ‚àà [0, BURN_TURNS]

    –î–µ–π—Å—Ç–≤–∏–µ (action): Discrete(6) ‚Äî –≤—ã–±—Ä–∞—Ç—å —Ü–µ–ª—å —Å—Ä–µ–¥–∏ RED –ø–æ–∑–∏—Ü–∏–π 1..6.

    –ò–º–º—É–Ω–∏—Ç–µ—Ç—ã/—ç—Ñ—Ñ–µ–∫—Ç—ã:
      ‚Ä¢ –£—Ä–æ–Ω –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è, –µ—Å–ª–∏ –¢–∏–ø –∞—Ç–∞–∫–∏ 1 –∞—Ç–∞–∫—É—é—â–µ–≥–æ ‚àà –∏–º–º—É–Ω–∏—Ç–µ—Ç —Ü–µ–ª–∏.
      ‚Ä¢ –ù–∞–ª–æ–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è, –µ—Å–ª–∏ –¢–∏–ø –∞—Ç–∞–∫–∏ 2 –∞—Ç–∞–∫—É—é—â–µ–≥–æ (–µ—Å–ª–∏ –Ω–µ –ø—É—Å—Ç) ‚àà –∏–º–º—É–Ω–∏—Ç–µ—Ç —Ü–µ–ª–∏.
      ‚Ä¢ –ë—Ä–æ–Ω—è: –≤—Ö–æ–¥—è—â–∏–π —É—Ä–æ–Ω —É–º–Ω–æ–∂–∞–µ—Ç—Å—è –Ω–∞ (1 - –±—Ä–æ–Ω—è/100).
      ‚Ä¢ –¢–æ—á–Ω–æ—Å—Ç—å: –ø–µ—Ä–µ–¥ —Ä–∞—Å—á—ë—Ç–æ–º —É—Ä–æ–Ω–∞ –±—Ä–æ—Å–∞–µ—Ç—Å—è —à–∞–Ω—Å –ø–æ–ø–∞–¥–∞–Ω–∏—è; –ø—Ä–∏ –ø—Ä–æ–º–∞—Ö–µ —É—Ä–æ–Ω=0 –∏ —Å—Ç–∞—Ç—É—Å—ã –Ω–µ –Ω–∞–∫–ª–∞–¥—ã–≤–∞—é—Ç—Å—è.
      ‚Ä¢ –Ø–¥: —É—Ä–æ–Ω –≤ –Ω–∞—á–∞–ª–µ —Ö–æ–¥–∞ = poison_damage_per_tick (—Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –Ω–∞–ª–æ–∂–µ–Ω–∏–∏), —Ç–∏–∫–æ–≤ POISON_TURNS.
            –ï—Å–ª–∏ —É —Ü–µ–ª–∏ –∏–º–º—É–Ω–∏—Ç–µ—Ç –∫ "poison", –Ω–∏ –Ω–∞–ª–æ–∂–µ–Ω–∏–µ, –Ω–∏ —Ç–∏–∫–∏ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç.
    """

    metadata = {"render_modes": []}

    def __init__(self,
                 reward_win: float = 1.0,
                 reward_loss: float = -1.0,
                 reward_step: float = 0.0,
                 penalty_invalid_target: float = -0.10,
                 penalty_unreachable_warrior: float = -0.20,
                 log_enabled: bool = False):
        super().__init__()
        self.reward_win  = float(reward_win)
        self.reward_loss = float(reward_loss)
        self.reward_step = float(reward_step)

        self.penalty_invalid_target = float(penalty_invalid_target)
        self.penalty_unreachable_warrior = float(penalty_unreachable_warrior)

        self.log_enabled = bool(log_enabled)
        self._pretty_events: List[str] = []

        # –ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –¥–µ–π—Å—Ç–≤–∏–π
        self.action_space = spaces.Discrete(6)

        # –ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π
        low_unit = np.array(
            [0, 0, 0, 0, 0, 0, 1, 0]   # HP, INI, INI_base, DMG, DMG2, team, pos, stand
            + [0]*len(TYPE_LIST)
            + [0]*len(ATTACK_TYPES)
            + [0]*len(ATTACK_TYPES)
            + [0]*len(ATTACK_TYPES)
            + [0]           # armor
            + [0]           # accuracy
            + [0, 0],       # poison_left, burn_left
            dtype=np.float32
        )
        high_unit = np.array(
            [MAX_HP, MAX_INIT, MAX_INIT, MAX_DMG, MAX_DMG2, 1, 12, 1]
            + [1]*len(TYPE_LIST)
            + [1]*len(ATTACK_TYPES)
            + [1]*len(ATTACK_TYPES)
            + [1]*len(ATTACK_TYPES)
            + [100]         # armor
            + [100]         # accuracy
            + [POISON_TURNS, BURN_TURNS],
            dtype=np.float32
        )
        low  = np.tile(low_unit, 12)
        high = np.tile(high_unit, 12)
        self.observation_space = spaces.Box(low=low, high=high, dtype=np.float32)

        # –°–æ—Å—Ç–æ—è–Ω–∏–µ –±–æ—è
        self.rng = random.Random()
        self.combined: List[Dict] = []
        self.round_no: int = 1
        self.winner: Optional[str] = None
        self.current_blue_attacker_pos: Optional[int] = None
        self.blue_attacks_left: int = 0
        self._lord_applied_burn: Dict[int, bool] = {}

    # ------------------ –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã ------------------

    def seed(self, seed=None):
        self.rng = random.Random(seed)

    def _alive(self, u) -> bool:
        return u["–ó–¥–æ—Ä–æ–≤—å–µ"] > 0

    def _team_alive(self, team: str) -> bool:
        return any(self._alive(u) and u["team"] == team for u in self.combined)

    def _unit_by_position(self, pos: int):
        return next((u for u in self.combined if u["position"] == pos), None)

    def _live_positions_of(self, team: str):
        return [u["position"] for u in self.combined if u["team"] == team and self._alive(u)]

    def _log(self, s: str):
        if self.log_enabled:
            self._pretty_events.append(s)

    def pop_pretty_events(self) -> List[str]:
        out = self._pretty_events[:]
        self._pretty_events.clear()
        return out

    def _col_of(self, pos: int) -> int:
        return (pos - 1) % 3

    def _enemy_rows(self, team: str):
        if team == "red":
            return [7, 8, 9], [10, 11, 12]
        else:
            return [1, 2, 3], [4, 5, 6]

    def _warrior_near_far_cols(self, col: int):
        if col == 0:   return [0, 1], [2]
        if col == 1:   return [0, 1, 2], []
        return [1, 2], [0]

    def _warrior_allowed_targets(self, attacker: Dict) -> List[int]:
        assert attacker.get("Type") in ("–í–æ–∏–Ω", "Demon", "lord")
        if attacker["stand"] == "behind":
            if any(self._alive(u) and u["team"] == attacker["team"]
                   and u.get("Type") in ("–í–æ–∏–Ω", "Demon", "lord") and u["stand"] == "ahead"
                   for u in self.combined):
                return []
        ahead, behind = self._enemy_rows(attacker["team"])
        col = self._col_of(attacker["position"])
        near_cols, far_cols = self._warrior_near_far_cols(col)

        def alive(pos):
            uu = self._unit_by_position(pos)
            return uu is not None and self._alive(uu)

        near = [ahead[c] for c in near_cols if alive(ahead[c])]
        if near: return near
        far = [ahead[c] for c in far_cols if alive(ahead[c])]
        if far: return far

        near2 = [behind[c] for c in near_cols if alive(behind[c])]
        if near2: return near2
        far2 = [behind[c] for c in far_cols if alive(behind[c])]
        return far2

    # ----------- —ç—Ñ—Ñ–µ–∫—Ç—ã –Ω–∞—á–∞–ª–∞ —Ö–æ–¥–∞ (—è–¥/–ø–æ–¥–∂–æ–≥) -----------
    def _apply_start_of_turn_effects(self, unit: Dict) -> bool:
        # –Ø–î ‚Äî –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —É—Ä–æ–Ω –∏–∑ poison_damage_per_tick
        if unit.get("poison_turns_left", 0) > 0 and self._alive(unit):
            if "poison" in (unit.get("–∏–º–º—É–Ω–∏—Ç–µ—Ç") or []):
                unit["poison_turns_left"] = 0
                unit["poison_damage_per_tick"] = 0
                self._log(f"üõ° –ò–º–º—É–Ω–∏—Ç–µ—Ç –∫ —ç—Ñ—Ñ–µ–∫—Ç—É 'poison' ‚Äî —è–¥ –Ω–µ –¥–µ–π—Å—Ç–≤—É–µ—Ç –Ω–∞ {unit['team'].upper()} {unit['–∏–º—è']}#{unit['position']}.")
            else:
                tick = int(unit.get("poison_damage_per_tick", 0) or 0)
                if tick > 0:
                    before = unit["–ó–¥–æ—Ä–æ–≤—å–µ"]
                    unit["–ó–¥–æ—Ä–æ–≤—å–µ"] -= tick
                    unit["poison_turns_left"] -= 1
                    after = unit["–ó–¥–æ—Ä–æ–≤—å–µ"]
                    self._log(f"‚ò† –Ø–¥ –ø–æ—Ä–∞–∂–∞–µ—Ç {unit['team'].upper()} {unit['–∏–º—è']}#{unit['position']}: "
                              f"{tick} ({before}‚Üí{max(0, after)}); –æ—Å—Ç–∞–ª–æ—Å—å —Ö–æ–¥–æ–≤: {unit['poison_turns_left']}")
                    if unit["–ó–¥–æ—Ä–æ–≤—å–µ"] <= 0:
                        unit["–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞"] = 0
                        self._log(f"‚úñ {unit['team'].upper()} {unit['–∏–º—è']}#{unit['position']} –ø–æ–≥–∏–±–∞–µ—Ç –æ—Ç —è–¥–∞.")
                        self._check_victory_after_hit()
                        return False
                else:
                    unit["poison_turns_left"] -= 1
                if unit["poison_turns_left"] <= 0:
                    unit["poison_damage_per_tick"] = 0

        # –ü–û–î–ñ–û–ì ‚Äî —Ñ–∏–∫—Å 10
        if unit.get("burn_turns_left", 0) > 0 and self._alive(unit):
            before = unit["–ó–¥–æ—Ä–æ–≤—å–µ"]
            unit["–ó–¥–æ—Ä–æ–≤—å–µ"] -= BURN_DAMAGE
            unit["burn_turns_left"] -= 1
            after = unit["–ó–¥–æ—Ä–æ–≤—å–µ"]
            self._log(f"üî• –ü–æ–¥–∂–æ–≥ –ø–æ—Ä–∞–∂–∞–µ—Ç {unit['team'].upper()} {unit['–∏–º—è']}#{unit['position']}: "
                      f"{BURN_DAMAGE} ({before}‚Üí{max(0, after)}); –æ—Å—Ç–∞–ª–æ—Å—å —Ö–æ–¥–æ–≤: {unit['burn_turns_left']}")
            if unit["–ó–¥–æ—Ä–æ–≤—å–µ"] <= 0:
                unit["–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞"] = 0
                self._log(f"‚úñ {unit['team'].upper()} {unit['–∏–º—è']}#{unit['position']} –ø–æ–≥–∏–±–∞–µ—Ç –æ—Ç –ø–æ–¥–∂–æ–≥–∞.")
                self._check_victory_after_hit()
                return False

        return True

    # ------------------ –ë–æ–µ–≤–∞—è –ª–æ–≥–∏–∫–∞ ------------------

    def _reset_state(self):
        self.combined = [u.copy() for u in (UNITS_RED + UNITS_BLUE)]
        for u in self.combined:
            u["–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞"] = u.get("–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞_–±–∞–∑–∞", 0)
            u.setdefault("–¢–∏–ø –∞—Ç–∞–∫–∏ 1", "Weapon")
            u.setdefault("–¢–∏–ø –∞—Ç–∞–∫–∏ 2", "")
            u.setdefault("–∏–º–º—É–Ω–∏—Ç–µ—Ç", [])
            u.setdefault("–±—Ä–æ–Ω—è", 0)
            u.setdefault("–¢–æ—á–Ω–æ—Å—Ç—å", 100)
            u.setdefault("—É—Ä–æ–Ω2", 0)
            u["poison_turns_left"] = 0
            u["poison_damage_per_tick"] = 0
            u["burn_turns_left"] = 0
        self.round_no = 1
        self.winner = None
        self.current_blue_attacker_pos = None
        self.blue_attacks_left = 0
        self._lord_applied_burn = {}
        self._log(f"–≠–ø–∏–∑–æ–¥ –Ω–∞—á–∞—Ç. –†–∞—É–Ω–¥ {self.round_no}.")

    def _candidates(self):
        return [u for u in self.combined if self._alive(u) and u["–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞"] > 0]

    def _pop_next(self):
        cand = self._candidates()
        if not cand:
            return None
        self.rng.shuffle(cand)
        cand.sort(key=itemgetter("–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞"), reverse=True)
        return cand[0]

    def _end_round_restore(self):
        for u in self.combined:
            u["–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞"] = u.get("–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞_–±–∞–∑–∞", 0) if self._alive(u) else 0
        self._log("–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã. –ù–æ–≤—ã–π —Ä–∞—É–Ω–¥.")

    # --- –∏–º–º—É–Ω–∏—Ç–µ—Ç—ã/–±—Ä–æ–Ω—è/—Ç–æ—á–Ω–æ—Å—Ç—å ---
    def _is_immune_damage(self, attacker: Dict, victim: Dict) -> bool:
        atk1 = attacker.get("–¢–∏–ø –∞—Ç–∞–∫–∏ 1", "Weapon")
        return atk1 in (victim.get("–∏–º–º—É–Ω–∏—Ç–µ—Ç") or [])

    def _is_immune_status(self, attacker: Dict, victim: Dict) -> bool:
        atk2 = attacker.get("–¢–∏–ø –∞—Ç–∞–∫–∏ 2", "")
        return bool(atk2) and (atk2 in (victim.get("–∏–º–º—É–Ω–∏—Ç–µ—Ç") or []))

    def _apply_damage_with_armor(self, base_dmg: float, victim: Dict) -> int:
        armor = float(victim.get("–±—Ä–æ–Ω—è", 0) or 0)
        factor = (1.0 - armor / 100.0) if armor > 0 else 1.0
        eff = base_dmg * max(0.0, factor)
        return int(round(eff))

    def _roll_hit(self, attacker: Dict) -> bool:
        acc = float(attacker.get("–¢–æ—á–Ω–æ—Å—Ç—å", 100) or 0)
        return self.rng.random() < (acc / 100.0)

    def _attack(self, attacker, target_pos: Optional[int]):
        """
        –í—ã–ø–æ–ª–Ω–∏—Ç—å —É—Ä–æ–Ω.
        –í–æ–∑–≤—Ä–∞—Ç: (hit: bool, reason: str)
          reason ‚àà {"ok","dead_or_absent","aoe","aoe_no_targets","immune_damage","immune_status","miss"}
        """
        # AoE –¥–ª—è Mage –∏ Dead dragon
        if attacker is not None and attacker.get("Type") in ("Mage", "Dead dragon"):
            enemy_team = "blue" if attacker["team"] == "red" else "red"
            targets = [u for u in self.combined if u["team"] == enemy_team and self._alive(u)]
            if targets:
                atype = attacker.get("Type")
                self._log(f"{attacker['team'].upper()} {attacker['–∏–º—è']}#{attacker['position']} ({atype}) –ø—Ä–∏–º–µ–Ω—è–µ—Ç –º–∞—Å—Å–æ–≤—É—é –∞—Ç–∞–∫—É.")
                for victim in targets:
                    # 1) —Ç–æ—á–Ω–æ—Å—Ç—å –ø–æ –∫–∞–∂–¥–æ–π —Ü–µ–ª–∏
                    if not self._roll_hit(attacker):
                        self._log(f"üí® –ü—Ä–æ–º–∞—Ö: {attacker['team'].upper()} {attacker['–∏–º—è']}#{attacker['position']} –ø–æ "
                                  f"{victim['team'].upper()} {victim['–∏–º—è']}#{victim['position']}.")
                        continue
                    # 2) –∏–º–º—É–Ω–∏—Ç–µ—Ç –∫ —É—Ä–æ–Ω—É
                    if self._is_immune_damage(attacker, victim):
                        self._log(f"üõ° –ò–º–º—É–Ω–∏—Ç–µ—Ç –∫ —É—Ä–æ–Ω—É '{attacker.get('–¢–∏–ø –∞—Ç–∞–∫–∏ 1','')}' ‚Äî "
                                  f"{victim['team'].upper()} {victim['–∏–º—è']}#{victim['position']}: —É—Ä–æ–Ω 0.")
                        continue
                    # 3) —É—Ä–æ–Ω
                    before = victim["–ó–¥–æ—Ä–æ–≤—å–µ"]
                    dmg = self._apply_damage_with_armor(attacker["–£—Ä–æ–Ω"], victim)
                    victim["–ó–¥–æ—Ä–æ–≤—å–µ"] -= dmg
                    after = victim["–ó–¥–æ—Ä–æ–≤—å–µ"]
                    self._log(f"{attacker['team'].upper()} {attacker['–∏–º—è']}#{attacker['position']} ‚Üí "
                              f"{victim['team'].upper()} {victim['–∏–º—è']}#{victim['position']}: {dmg} "
                              f"({before}‚Üí{max(0, after)})")
                    # 4) —Å–º–µ—Ä—Ç—å / —Å—Ç–∞—Ç—É—Å—ã
                    if victim["–ó–¥–æ—Ä–æ–≤—å–µ"] <= 0:
                        victim["–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞"] = 0
                        self._log(f"‚úñ {victim['team'].upper()} {victim['–∏–º—è']}#{victim['position']} –≤—ã–≤–µ–¥–µ–Ω –∏–∑ —Å—Ç—Ä–æ—è.")
                    else:
                        # Dead dragon: 40% —à–∞–Ω—Å —è–¥–∞
                        if atype == "Dead dragon" and self.rng.random() < 0.40:
                            if self._is_immune_status(attacker, victim):
                                self._log(f"üõ° –ò–º–º—É–Ω–∏—Ç–µ—Ç –∫ —ç—Ñ—Ñ–µ–∫—Ç—É '{attacker.get('–¢–∏–ø –∞—Ç–∞–∫–∏ 2','')}' ‚Äî —è–¥ –ù–ï –Ω–∞–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è "
                                          f"–Ω–∞ {victim['team'].upper()} {victim['–∏–º—è']}#{victim['position']}.")
                            else:
                                victim["poison_turns_left"] = POISON_TURNS
                                victim["poison_damage_per_tick"] = int(attacker.get("—É—Ä–æ–Ω2", 0) or 0)
                                self._log(f"‚ò† {attacker['team'].upper()} {attacker['–∏–º—è']}#{attacker['position']} –Ω–∞–∫–ª–∞–¥—ã–≤–∞–µ—Ç —è–¥ "
                                          f"({victim['poison_damage_per_tick']} —É—Ä–æ–Ω–∞/—Ö–æ–¥) –Ω–∞ "
                                          f"{victim['team'].upper()} {victim['–∏–º—è']}#{victim['position']} –Ω–∞ {POISON_TURNS} —Ö–æ–¥–∞.")
                return True, "aoe"
            else:
                self._log(f"{attacker['team'].upper()} {attacker['–∏–º—è']}#{attacker['position']} ({attacker.get('Type')}) –ø—Ä–∏–º–µ–Ω—è–µ—Ç –º–∞—Å—Å–æ–≤—É—é –∞—Ç–∞–∫—É: —Ü–µ–ª–µ–π –Ω–µ—Ç.")
                return False, "aoe_no_targets"

        # –û–±—ã—á–Ω–∞—è –æ–¥–∏–Ω–æ—á–Ω–∞—è –∞—Ç–∞–∫–∞
        victim = self._unit_by_position(target_pos) if target_pos is not None else None
        if victim is not None and self._alive(victim):
            # 1) —Ç–æ—á–Ω–æ—Å—Ç—å
            if not self._roll_hit(attacker):
                self._log(f"üí® –ü—Ä–æ–º–∞—Ö: {attacker['team'].upper()} {attacker['–∏–º—è']}#{attacker['position']} –ø–æ "
                          f"{victim['team'].upper()} {victim['–∏–º—è']}#{victim['position']}.")
                return True, "miss"

            # 2) –∏–º–º—É–Ω–∏—Ç–µ—Ç –∫ —É—Ä–æ–Ω—É
            if self._is_immune_damage(attacker, victim):
                self._log(f"üõ° –ò–º–º—É–Ω–∏—Ç–µ—Ç –∫ —É—Ä–æ–Ω—É '{attacker.get('–¢–∏–ø –∞—Ç–∞–∫–∏ 1','')}' ‚Äî "
                          f"{victim['team'].upper()} {victim['–∏–º—è']}#{victim['position']}: –∞—Ç–∞–∫–∞ –Ω–∞–Ω–æ—Å–∏—Ç 0.")
                return True, "immune_damage"

            # 3) —É—Ä–æ–Ω
            before = victim["–ó–¥–æ—Ä–æ–≤—å–µ"]
            dmg = self._apply_damage_with_armor(attacker["–£—Ä–æ–Ω"], victim)
            victim["–ó–¥–æ—Ä–æ–≤—å–µ"] -= dmg
            after = victim["–ó–¥–æ—Ä–æ–≤—å–µ"]
            self._log(f"{attacker['team'].upper()} {attacker['–∏–º—è']}#{attacker['position']} ‚Üí "
                      f"{victim['team'].upper()} {victim['–∏–º—è']}#{victim['position']}: {dmg} "
                      f"({before}‚Üí{max(0, after)})")

            # 4) —Å—Ç–∞—Ç—É—Å—ã/–ø–æ–¥–∂–æ–≥
            if self._alive(victim):
                # Death: —è–¥ (–ø–µ—Ä–≤–æ–µ –ø–æ–ø–∞–¥–∞–Ω–∏–µ –ø–æ —Ü–µ–ª–∏)
                if attacker.get("Type") == "Death" and victim.get("poison_turns_left", 0) <= 0:
                    if self._is_immune_status(attacker, victim):
                        self._log(f"üõ° –ò–º–º—É–Ω–∏—Ç–µ—Ç –∫ —ç—Ñ—Ñ–µ–∫—Ç—É '{attacker.get('–¢–∏–ø –∞—Ç–∞–∫–∏ 2','')}' ‚Äî —è–¥ –ù–ï –Ω–∞–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è "
                                  f"–Ω–∞ {victim['team'].upper()} {victim['–∏–º—è']}#{victim['position']}.")
                    else:
                        victim["poison_turns_left"] = POISON_TURNS
                        victim["poison_damage_per_tick"] = int(attacker.get("—É—Ä–æ–Ω2", 0) or 0)
                        self._log(f"‚ò† {attacker['team'].upper()} {attacker['–∏–º—è']}#{attacker['position']} –Ω–∞–∫–ª–∞–¥—ã–≤–∞–µ—Ç —è–¥ "
                                  f"({victim['poison_damage_per_tick']} —É—Ä–æ–Ω–∞/—Ö–æ–¥) –Ω–∞ "
                                  f"{victim['team'].upper()} {victim['–∏–º—è']}#{victim['position']} –Ω–∞ {POISON_TURNS} —Ö–æ–¥–∞.")
                # lord: –ø–æ–¥–∂–æ–≥ (–ø–µ—Ä–≤–∞—è —É—Å–ø–µ—à–Ω–∞—è –∞—Ç–∞–∫–∞)
                if attacker.get("Type") == "lord":
                    pos = attacker["position"]
                    if not self._lord_applied_burn.get(pos, False):
                        if self._is_immune_status(attacker, victim):
                            self._log(f"üõ° –ò–º–º—É–Ω–∏—Ç–µ—Ç –∫ —ç—Ñ—Ñ–µ–∫—Ç—É '{attacker.get('–¢–∏–ø –∞—Ç–∞–∫–∏ 2','')}' ‚Äî –ø–æ–¥–∂–æ–≥ –ù–ï –Ω–∞–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è "
                                      f"–Ω–∞ {victim['team'].upper()} {victim['–∏–º—è']}#{victim['position']}.")
                        else:
                            victim["burn_turns_left"] = BURN_TURNS
                            self._lord_applied_burn[pos] = True
                            self._log(f"üî• {attacker['team'].upper()} {attacker['–∏–º—è']}#{pos} –Ω–∞–∫–ª–∞–¥—ã–≤–∞–µ—Ç –ø–æ–¥–∂–æ–≥ –Ω–∞ "
                                      f"{victim['team'].upper()} {victim['–∏–º—è']}#{victim['position']} –Ω–∞ {BURN_TURNS} —Ö–æ–¥–∞.")

            if victim["–ó–¥–æ—Ä–æ–≤—å–µ"] <= 0:
                victim["–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞"] = 0
                self._log(f"‚úñ {victim['team'].upper()} {victim['–∏–º—è']}#{victim['position']} –≤—ã–≤–µ–¥–µ–Ω –∏–∑ —Å—Ç—Ä–æ—è.")
            return True, "ok"
        else:
            self._log(f"{attacker['team'].upper()} {attacker['–∏–º—è']}#{attacker['position']} –±—å—ë—Ç pos{target_pos}: —Ü–µ–ª–∏ –Ω–µ—Ç/–º–µ—Ä—Ç–≤–∞/–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.")
            return False, "dead_or_absent"

    def _check_victory_after_hit(self):
        if not self._team_alive("blue"):
            self.winner = "red";  self._log("üèÜ –ü–æ–±–µ–¥–∞ RED!")
        elif not self._team_alive("red"):
            self.winner = "blue"; self._log("üèÜ –ü–æ–±–µ–¥–∞ BLUE!")

    def _advance_until_blue_turn(self) -> bool:
        """
        –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ö–æ–¥–∞ BLUE –∏–ª–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –±–æ—è.
        RED —Ö–æ–¥–∏—Ç —Å–∞–º: Archer/Death/gargoil ‚Äî —Å–ª—É—á–∞–π–Ω–æ; –í–æ–∏–Ω/Demon/lord ‚Äî –ø–æ —Å–º–µ–∂–Ω–æ—Å—Ç–∏ (Demon –±—å—ë—Ç –¥–≤–∞–∂–¥—ã).
        Mage/Dead dragon ‚Äî –º–∞—Å—Å–æ–≤–∞—è –∞—Ç–∞–∫–∞.
        """
        while self._team_alive("red") and self._team_alive("blue"):
            nxt = self._pop_next()
            if nxt is None:
                self._log(f"‚Äî –ö–æ–Ω–µ—Ü —Ä–∞—É–Ω–¥–∞ {self.round_no}.")
                self._end_round_restore()
                self.round_no += 1
                self._log(f"‚Äî –ù–∞—á–∞–ª–æ —Ä–∞—É–Ω–¥–∞ {self.round_no}.")
                continue

            # –≠—Ñ—Ñ–µ–∫—Ç—ã –Ω–∞—á–∞–ª–∞ —Ö–æ–¥–∞
            if not self._apply_start_of_turn_effects(nxt):
                if self.winner is not None:
                    return False
                continue

            if nxt["team"] == "blue":
                self.current_blue_attacker_pos = nxt["position"]
                self.blue_attacks_left = 2 if (nxt.get("Type") == "Demon") else 1
                self._log(
                    f"–•–æ–¥ BLUE: {nxt['–∏–º—è']}#{nxt['position']} (–∏–Ω–∏—Ü {nxt['–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞']}). "
                    + ("–û–∂–∏–¥–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è (–¥–µ–º–æ–Ω: 2 —É–¥–∞—Ä–∞)." if self.blue_attacks_left == 2 else "–û–∂–∏–¥–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è.")
                )
                return True

            # –•–æ–¥ RED (–∞–≤—Ç–æ)
            nxt["–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞"] = 0
            strikes = 2 if nxt.get("Type") == "Demon" else 1

            for hit_i in range(strikes):
                if self.winner is not None:
                    return False

                target_pos = None
                if nxt.get("Type") in ("–í–æ–∏–Ω", "Demon", "lord"):
                    options = self._warrior_allowed_targets(nxt)
                    if options:
                        target_pos = self.rng.choice(options)
                        prefix = nxt.get("Type")
                        self._log(f"RED —Ö–æ–¥: {nxt['–∏–º—è']}#{nxt['position']} ({prefix}) ‚Üí —Ü–µ–ª—å pos{target_pos} (—É–¥–∞—Ä {hit_i+1}/{strikes}).")
                    else:
                        self._log(f"RED —Ö–æ–¥: {nxt['–∏–º—è']}#{nxt['position']} ({nxt.get('Type')}) –Ω–µ –º–æ–∂–µ—Ç –∞—Ç–∞–∫–æ–≤–∞—Ç—å: –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ü–µ–ª–µ–π –Ω–µ—Ç.")
                elif nxt.get("Type") in ("Mage", "Dead dragon"):
                    if hit_i == 0:
                        self._log(f"RED —Ö–æ–¥: {nxt['–∏–º—è']}#{nxt['position']} ({nxt.get('Type')}) –≤—ã–ø–æ–ª–Ω—è–µ—Ç –º–∞—Å—Å–æ–≤—É—é –∞—Ç–∞–∫—É.")
                    else:
                        break
                else:
                    # Archer / gargoil / Death ‚Äî —Å–ª—É—á–∞–π–Ω–∞—è –∂–∏–≤–∞—è —Ü–µ–ª—å
                    live_blue_positions = self._live_positions_of("blue")
                    target_pos = self.rng.choice(live_blue_positions) if live_blue_positions else None
                    ut = nxt.get("Type")
                    self._log(f"RED —Ö–æ–¥: {nxt['–∏–º—è']}#{nxt['position']} ({ut}) ‚Üí —Å–ª—É—á–∞–π–Ω–∞—è —Ü–µ–ª—å pos{target_pos} (—É–¥–∞—Ä {hit_i+1}/{strikes}).")

                if target_pos is not None or nxt.get("Type") in ("Mage", "Dead dragon"):
                    self._attack(nxt, target_pos)
                    self._check_victory_after_hit()
                    if self.winner is not None:
                        return False
        return False

    # ------------------ –ù–∞–±–ª—é–¥–µ–Ω–∏–µ –¥–ª—è –∞–≥–µ–Ω—Ç–∞ ------------------

    def _obs(self) -> np.ndarray:
        """
        –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ (12√ó35=420):
        [HP, INI, INI_base, DMG, DMG2, team, pos, stand,
         TYPE(8), IMM(5), ATK1(5), ATK2(5), armor, accuracy, poison_left, burn_left] √ó 12
        """
        vec = []
        for pos in RED_POSITIONS + BLUE_POSITIONS:
            u = self._unit_by_position(pos)
            hp      = float(max(0, u["–ó–¥–æ—Ä–æ–≤—å–µ"]))
            ini     = float(max(0, u["–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞"]))
            ini_b   = float(u.get("–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞_–±–∞–∑–∞", 0))
            dmg     = float(u["–£—Ä–æ–Ω"])
            dmg2    = float(u.get("—É—Ä–æ–Ω2", 0))
            team_v  = 0.0 if u["team"] == "red" else 1.0
            pos_v   = float(u["position"])
            stand_v = 0.0 if u["stand"] == "ahead" else 1.0

            t_onehot   = _one_hot(u.get("Type","Archer"), TYPE_LIST)
            imm_mhot   = _multi_hot(u.get("–∏–º–º—É–Ω–∏—Ç–µ—Ç", []), ATTACK_TYPES)
            atk1_oh    = _one_hot(u.get("–¢–∏–ø –∞—Ç–∞–∫–∏ 1",""), ATTACK_TYPES) if u.get("–¢–∏–ø –∞—Ç–∞–∫–∏ 1","") in ATTACK_TYPES else [0.0]*len(ATTACK_TYPES)
            atk2_oh    = _one_hot(u.get("–¢–∏–ø –∞—Ç–∞–∫–∏ 2",""), ATTACK_TYPES) if u.get("–¢–∏–ø –∞—Ç–∞–∫–∏ 2","") in ATTACK_TYPES else [0.0]*len(ATTACK_TYPES)
            armor_v    = float(u.get("–±—Ä–æ–Ω—è", 0))
            acc_v      = float(u.get("–¢–æ—á–Ω–æ—Å—Ç—å", 100))
            poison_v   = float(u.get("poison_turns_left", 0))
            burn_v     = float(u.get("burn_turns_left", 0))

            vec.extend([hp, ini, ini_b, dmg, dmg2, team_v, pos_v, stand_v,
                        *t_onehot, *imm_mhot, *atk1_oh, *atk2_oh,
                        armor_v, acc_v, poison_v, burn_v])
        return np.array(vec, dtype=np.float32)

    # ------------------ API Gymnasium ------------------

    def reset(self, *, seed=None, options=None):
        if seed is not None:
            self.seed(seed)
        self._reset_state()
        self._advance_until_blue_turn()
        return self._obs(), {}

    def step(self, action):
        assert self.winner is None, "–≠–ø–∏–∑–æ–¥ –∑–∞–≤–µ—Ä—à—ë–Ω ‚Äî –≤—ã–∑–æ–≤–∏—Ç–µ reset()."

        # –î–æ–∫—Ä—É—Ç–∫–∞ –¥–æ BLUE, –µ—Å–ª–∏ –≤–Ω–µ–∑–∞–ø–Ω–æ –Ω–µ –µ–≥–æ –æ—á–µ—Ä–µ–¥—å
        if self.current_blue_attacker_pos is None:
            self._advance_until_blue_turn()
            if self.winner is not None:
                base = self.reward_win if self.winner == "blue" else self.reward_loss
                return self._obs(), base, True, False, {}

        step_shaping = 0.0

        # –í—Ç–æ—Ä–∞—è –∞—Ç–∞–∫–∞ –î–µ–º–æ–Ω–∞ –¥–æ–ø—É—Å—Ç–∏–º–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–µ 0 (–µ—Å–ª–∏ –æ—Å—Ç–∞–ª–∏—Å—å —É–¥–∞—Ä—ã)
        target_pos = RED_POSITIONS[int(action)]
        attacker = self._unit_by_position(self.current_blue_attacker_pos)
        can_strike = (
            attacker is not None
            and self._alive(attacker)
            and (attacker["–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞"] > 0 or (attacker.get("Type") == "Demon" and self.blue_attacks_left > 0))
        )
        if can_strike:
            self._log(f"BLUE –¥–µ–π—Å—Ç–≤–∏–µ: {attacker['–∏–º—è']}#{attacker['position']} ‚Üí pos{target_pos}")
            attacker["–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞"] = 0

            if attacker.get("Type") in ("–í–æ–∏–Ω", "Demon", "lord"):
                allowed = self._warrior_allowed_targets(attacker)
                if target_pos not in allowed:
                    self._log(
                        f"BLUE {attacker['–∏–º—è']}#{attacker['position']} ({attacker.get('Type')}) –Ω–µ –º–æ–∂–µ—Ç –¥–æ—Å—Ç–∞—Ç—å pos{target_pos}. "
                        f"–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ü–µ–ª–∏: {(', '.join('pos'+str(p) for p in allowed)) if allowed else '–Ω–µ—Ç'}"
                    )
                    step_shaping += self.penalty_unreachable_warrior
                else:
                    hit, reason = self._attack(attacker, target_pos)
                    if not hit and reason == "dead_or_absent":
                        step_shaping += self.penalty_invalid_target
                    self._check_victory_after_hit()
            elif attacker.get("Type") in ("Mage", "Dead dragon"):
                hit, reason = self._attack(attacker, target_pos)
                self._check_victory_after_hit()
            else:
                hit, reason = self._attack(attacker, target_pos)
                if not hit and reason == "dead_or_absent":
                    step_shaping += self.penalty_invalid_target
                self._check_victory_after_hit()

        if self.winner is None:
            if self.blue_attacks_left > 0:
                self.blue_attacks_left -= 1
            if self.blue_attacks_left > 0:
                reward, terminated = self.reward_step + step_shaping, False
                return self._obs(), reward, terminated, False, {}
            self.current_blue_attacker_pos = None
            self._advance_until_blue_turn()

        if self.winner is None:
            base = self.reward_step
            terminated = False
        else:
            base = self.reward_win if self.winner == "blue" else self.reward_loss
            terminated = True

        reward = base + step_shaping
        return self._obs(), reward, terminated, False, {}

# ============================================================
# –ë–õ–û–ö 2: –û–ë–£–ß–ï–ù–ò–ï PPO + W&B, –¢–ï–°–¢ –ò –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø (–±–µ–∑ –ø–∞–Ω–µ–ª–∏ –ª–æ–≥–æ–≤; –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∏ –ø—Ä–æ–º–∞—Ö–∏)
# ============================================================

# (–ö–æ–ª–∞–±) –£—Å—Ç–∞–Ω–æ–≤–∏–º –Ω—É–∂–Ω—ã–µ –ø–∞–∫–µ—Ç—ã: SB3 –∏ W&B. Gymnasium —É–∂–µ —Å—Ç–æ–∏—Ç.
try:
    import wandb  # noqa
except Exception:
    # noqa
    !pip -q install "stable-baselines3[extra]" wandb

import os
import re
import time
import shutil
import random
import numpy as np
import torch
from stable_baselines3 import PPO
from stable_baselines3.common.env_util import make_vec_env
from stable_baselines3.common.monitor import Monitor
from stable_baselines3.common.callbacks import CallbackList, EvalCallback
import wandb
from wandb.integration.sb3 import WandbCallback

# -------------------- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–±—É—á–µ–Ω–∏—è –∏ —Ç–µ—Å—Ç–∞ --------------------
TOTAL_STEPS     = 300000
N_ENVS          = 8
MODEL_SAVE_FREQ = 10_000
EVAL_FREQ       = 10_000
SEED            = 42

VISUALIZE_TEST = True
FRAME_DELAY    = 0.28

# -------------------- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è W&B --------------------
# –ü–µ—Ä–µ–¥ –ø–µ—Ä–≤—ã–º –∑–∞–ø—É—Å–∫–æ–º: wandb.login()
run = wandb.init(
    project="red-blue-battle",
    name=f"ppo-{TOTAL_STEPS//1000}k-poison-dmg2",
    config={
        "algo": "PPO",
        "total_timesteps": TOTAL_STEPS,
        "n_envs": N_ENVS,
        "n_steps": 1024,
        "batch_size": 2048,
        "gamma": 0.99,
        "gae_lambda": 0.95,
        "learning_rate": 3e-4,
        "clip_range": 0.2,
        "model_save_freq": MODEL_SAVE_FREQ,
        "eval_freq": EVAL_FREQ,
        "obs_dim": 12*35,
        "types": TYPE_LIST,
        "attack_types": ATTACK_TYPES,
    },
    sync_tensorboard=True,
    save_code=True,
)

# -------------------- –§–∞–±—Ä–∏–∫–∞ —Å—Ä–µ–¥ --------------------
def make_env():
    return Monitor(BattleEnv(
        reward_win=1.0, reward_loss=-1.0, reward_step=0.0,
        log_enabled=False
    ))

vec_env  = make_vec_env(make_env, n_envs=N_ENVS, seed=SEED)
eval_env = Monitor(BattleEnv(log_enabled=False))

# -------------------- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–¥–µ–ª–∏ PPO --------------------
model = PPO(
    policy="MlpPolicy",
    env=vec_env,
    verbose=1,
    n_steps=1024,
    batch_size=2048,
    gae_lambda=0.95,
    gamma=0.99,
    n_epochs=10,
    learning_rate=3e-4,
    clip_range=0.2,
    ent_coef=0.0,
    vf_coef=0.5,
    seed=SEED,
    tensorboard_log=f"./tb_logs/{run.id}",
)

# -------------------- –ö–æ–ª–±—ç–∫–∏ W&B –∏ –æ—Ü–µ–Ω–∫–∏ --------------------
wandb_cb = WandbCallback(
    gradient_save_freq=10000,
    model_save_path=f"./models/{run.id}",
    model_save_freq=MODEL_SAVE_FREQ,
    verbose=2,
)
eval_cb = EvalCallback(
    eval_env,
    best_model_save_path=f"./models/{run.id}/best",
    log_path=f"./eval/{run.id}",
    eval_freq=EVAL_FREQ,
    n_eval_episodes=5,
    deterministic=True,
    render=False,
)

# -------------------- –û–±—É—á–µ–Ω–∏–µ --------------------
model.learn(total_timesteps=TOTAL_STEPS, callback=CallbackList([wandb_cb, eval_cb]))

# –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—É—é –º–æ–¥–µ–ª—å
model.save("ppo_blue_vs_red_poison_dmg2")
run.finish()

# -------------------- –¢–ï–°–¢–û–í–´–ô –ü–†–û–ì–û–ù –° –õ–û–ì–ê–ú–ò --------------------
print("\n=== –¢–ï–°–¢–û–í–´–ô –ü–†–û–ì–û–ù –° –õ–û–ì–ê–ú–ò ===")
test_env = BattleEnv(log_enabled=True)
obs, info = test_env.reset(seed=SEED + 123)

all_logs = []
all_logs += test_env.pop_pretty_events()

done = False
total_reward = 0.0
step_i = 0
while not done:
    step_i += 1
    action, _ = model.predict(obs, deterministic=True)
    target_pos = RED_POSITIONS[int(action)]
    chosen_line = f"[STEP {step_i}] –ê–≥–µ–Ω—Ç –≤—ã–±–∏—Ä–∞–µ—Ç action={int(action)} ‚Üí –∞—Ç–∞–∫–∞ RED pos{target_pos}"
    print("\n" + chosen_line)
    all_logs.append(chosen_line)

    obs, reward, terminated, truncated, info = test_env.step(action)
    total_reward += reward
    done = terminated or truncated

    new_lines = test_env.pop_pretty_events()
    all_logs += new_lines
    for line in new_lines:
        print(line)

print("\n=== –≠–ü–ò–ó–û–î –ó–ê–í–ï–†–®–Å–ù ===")
print("–ü–æ–±–µ–¥–∏—Ç–µ–ª—å:", test_env.winner.upper(), "| –°—É–º–º–∞—Ä–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞:", total_reward)

# -------------------- Matplotlib-–≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è (—Å—Ç—Ä–µ–ª–∫–∏ –∞—Ç–∞–∫, –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ, –ø—Ä–æ–º–∞—Ö–∏) --------------------
if VISUALIZE_TEST:
    import matplotlib.pyplot as plt
    from matplotlib import patches
    from matplotlib.patches import FancyArrowPatch
    from IPython.display import display
    import re, time, math

    VISUAL_SPEED_MULT = 8.0  # –º–Ω–æ–∂–∏—Ç–µ–ª—å –∑–∞–¥–µ—Ä–∂–∫–∏ (–±–æ–ª—å—à–µ = –º–µ–¥–ª–µ–Ω–Ω–µ–µ)

    # --- –≥–µ–æ–º–µ—Ç—Ä–∏—è –ø–æ–ª—è
    RED_FRONT, RED_BACK   = [1,2,3],   [4,5,6]
    BLUE_FRONT, BLUE_BACK = [7,8,9],   [10,11,12]
    COL_X = {0: 0.18, 1: 0.50, 2: 0.82}
    Y_BLUE_BACK, Y_BLUE_FRONT = 0.88, 0.70
    Y_RED_FRONT,  Y_RED_BACK  = 0.30, 0.12
    SLOT_W, SLOT_H = 0.28, 0.13
    HP_H = 0.025

    # --- —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –º–∞–∫—Å–∏–º—É–º HP
    state = {}
    def _suffix_by_type(t: str) -> str:
        return {
            "Mage": " (Mage)",
            "gargoil": " (Gargoil)",
            "–í–æ–∏–Ω": " (–≤–æ–∏–Ω)",
            "Demon": " (Demon)",
            "Death": " (Death)",
            "Archer": " (–ª—É—á–Ω–∏–∫)",
            "lord": " (Lord)",
            "Dead dragon": " (Dead dragon)",
        }.get(t, f" ({t})")

    for u in (UNITS_RED + UNITS_BLUE):
        t = u.get("Type", "Archer")
        per_type_max = HP_MAX_BY_TYPE.get(t, 60)
        start_hp = float(u["–ó–¥–æ—Ä–æ–≤—å–µ"])
        state[u["position"]] = {
            "team": u["team"],
            "name": u["–∏–º—è"] + _suffix_by_type(t),
            "hp": start_hp,
            "maxhp": max(per_type_max, start_hp),
            "stand": u["stand"],
            "type": t,
        }

    # --- —Ä–µ–≥–µ–∫—Å—ã —Å–æ–±—ã—Ç–∏–π (–∏–º–µ–Ω–∞ –¥–æ–ø—É—Å–∫–∞—é—Ç –ø—Ä–æ–±–µ–ª—ã: [^#]+)
    atk_re           = re.compile(r'^(RED|BLUE)\s+[^#]+#(\d+)\s+‚Üí\s+(RED|BLUE)\s+[^#]+#(\d+):\s+(\d+)\s+\((\d+)‚Üí(\d+)\)')
    kill_re          = re.compile(r'^‚úñ\s+(RED|BLUE)\s+[^#]+#(\d+)\s+–≤—ã–≤–µ–¥–µ–Ω –∏–∑ —Å—Ç—Ä–æ—è\.')
    vict_re          = re.compile(r'^üèÜ –ü–æ–±–µ–¥–∞ (RED|BLUE)!')
    blue_turn_re     = re.compile(r'^–•–æ–¥ BLUE:\s+[^#]+#(\d+)')
    red_turn_re      = re.compile(r'^RED —Ö–æ–¥:\s+[^#]+#(\d+)')
    blue_action_re   = re.compile(r'^BLUE –¥–µ–π—Å—Ç–≤–∏–µ:\s+[^#]+#(\d+)\s+‚Üí\s+pos(\d+)')
    red_target_re    = re.compile(r'^RED —Ö–æ–¥:\s+[^#]+#(\d+).+—Ü–µ–ª—å pos(\d+)')
    mage_banner_re   = re.compile(r'^\w+\s+[^#]+#(\d+)\s+\((?:Mage|Dead dragon)\).+–º–∞—Å—Å–æ–≤')
    blue_cant_re     = re.compile(r'^BLUE\s+[^#]+#(\d+).+–Ω–µ –º–æ–∂–µ—Ç –¥–æ—Å—Ç–∞—Ç—å pos(\d+)')
    poison_tick_re   = re.compile(r'^‚ò† –Ø–¥ –ø–æ—Ä–∞–∂–∞–µ—Ç (RED|BLUE)\s+[^#]+#(\d+):\s+(\d+)\s+\((\d+)‚Üí(\d+)\)')
    burn_tick_re     = re.compile(r'^üî• –ü–æ–¥–∂–æ–≥ –ø–æ—Ä–∞–∂–∞–µ—Ç (RED|BLUE)\s+[^#]+#(\d+):\s+(\d+)\s+\((\d+)‚Üí(\d+)\)')
    immune_dmg_re    = re.compile(r'^üõ° –ò–º–º—É–Ω–∏—Ç–µ—Ç –∫ —É—Ä–æ–Ω—É')
    immune_stat_re   = re.compile(r'^üõ° –ò–º–º—É–Ω–∏—Ç–µ—Ç –∫ —ç—Ñ—Ñ–µ–∫—Ç—É')
    miss_re          = re.compile(r'^üí® –ü—Ä–æ–º–∞—Ö:\s+(RED|BLUE)\s+[^#]+#(\d+)\s+–ø–æ\s+(RED|BLUE)\s+[^#]+#(\d+)\.')

    # --- —Ñ–∏–≥—É—Ä–∞ (–±–µ–∑ –º–µ—Ä—Ü–∞–Ω–∏—è)
    fig, ax = plt.subplots(figsize=(12, 8))
    plt.close(fig)
    handle = display(fig, display_id=True)

    # --- —É—Ç–∏–ª–∏—Ç—ã
    def pos_to_xy(pos: int):
        col = (pos - 1) % 3
        x = COL_X[col] - SLOT_W/2
        if pos in BLUE_BACK:   y = Y_BLUE_BACK  - SLOT_H/2
        elif pos in BLUE_FRONT:y = Y_BLUE_FRONT - SLOT_H/2
        elif pos in RED_FRONT: y = Y_RED_FRONT  - SLOT_H/2
        else:                  y = Y_RED_BACK   - SLOT_H/2
        return x, y

    def pos_center(pos: int):
        x, y = pos_to_xy(pos)
        return x + SLOT_W/2, y + SLOT_H/2

    def draw_unit(ax, pos, is_active: bool = False):
        u = state[pos]; x, y = pos_to_xy(pos)
        base = (0.90, 0.30, 0.30) if u["team"] == "red" else (0.30, 0.45, 0.90)
        ax.add_patch(patches.FancyBboxPatch((x, y), SLOT_W, SLOT_H,
                                            boxstyle="round,pad=0.008,rounding_size=0.015",
                                            linewidth=1.3, edgecolor="black", facecolor=base, alpha=0.18))
        if is_active:
            ax.add_patch(patches.FancyBboxPatch(
                (x-0.01, y-0.01), SLOT_W+0.02, SLOT_H+0.02,
                boxstyle="round,pad=0.012,rounding_size=0.018",
                linewidth=3.2, edgecolor=(1.0, 0.82, 0.10), facecolor='none', alpha=0.95
            ))

        label = u["name"][:22]
        ax.text(x + 0.012, y + SLOT_H*0.72, label,
                fontsize=10, fontweight="bold", ha="left", va="center", color="black")

        # HP-–±–∞—Ä
        hp_x, hp_y = x + 0.012, y + SLOT_H*0.20
        ax.add_patch(patches.Rectangle((hp_x, hp_y), SLOT_W-0.024, HP_H, color=(0.85,0.85,0.85), lw=0))
        frac = 0.0
        if u["maxhp"] > 1e-9:
            frac = max(0.0, min(1.0, u["hp"]/u["maxhp"]))
        ax.add_patch(patches.Rectangle((hp_x, hp_y), (SLOT_W-0.024)*frac, HP_H, color=(0.10,0.70,0.20), lw=0))
        ax.text(x + SLOT_W/2, hp_y + HP_H*2.2, f"{int(max(0,u['hp']))}/{int(u['maxhp'])} HP",
                fontsize=9, ha="center", va="center", color="black")

        ax.text(x + SLOT_W/2, y - 0.008, f"pos{pos}", fontsize=8, ha="center", va="top", color=(0.2,0.2,0.2))

    def draw_attack_arrow(ax, src_pos:int, dst_pos:int, team:str,
                          text: str|None = None,
                          style: str = "solid",
                          color: tuple|None = None,
                          alpha: float = 0.95,
                          curve: float = 0.18,
                          lw: float = 2.6):
        sx, sy = pos_center(src_pos)
        dx, dy = pos_center(dst_pos)

        vx, vy = dx - sx, dy - sy
        dist = math.hypot(vx, vy) + 1e-9
        pad = 0.06
        sx += vx/dist * pad
        sy += vy/dist * pad
        dx -= vx/dist * pad
        dy -= vy/dist * pad

        if color is None:
            color = (0.20, 0.35, 0.85) if team == "BLUE" else (0.85, 0.25, 0.25)

        con_style = f"arc3,rad={curve}" if abs(vx) > 0.01 and abs(vy) > 0.01 else "arc3,rad=0.0"
        arrow = FancyArrowPatch((sx, sy), (dx, dy),
                                arrowstyle="-|>",
                                mutation_scale=14,
                                linewidth=lw,
                                linestyle="--" if style == "dashed" else "solid",
                                color=color,
                                alpha=alpha,
                                connectionstyle=con_style)
        ax.add_patch(arrow)

        if text:
            mx, my = (sx + dx)/2, (sy + dy)/2
            ax.text(mx, my + 0.03, text, fontsize=10, fontweight="bold",
                    ha="center", va="center", color=color)

    # --- –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –≤—Å–µ–≥–æ –∫–∞–¥—Ä–∞ (—é–Ω–∏—Ç—ã + —Å—Ç—Ä–µ–ª–∫–∏ + —Ö–µ–¥–ª–∞–π–Ω)
    def draw_board(arrows: list[dict] = None, headline: str = "", active_pos: int | None = None):
        ax.cla()
        ax.set_xlim(0, 1); ax.set_ylim(0, 1); ax.axis("off")

        ax.plot([0.02, 0.98], [0.50, 0.50], color=(0.6,0.6,0.6), lw=1.2, ls="--", alpha=0.7)
        ax.text(0.01, 0.96, "BLUE (top)", color=(0.2,0.35,0.8), fontsize=12, fontweight="bold", ha="left")
        ax.text(0.01, 0.04, "RED (bottom)", color=(0.8,0.25,0.25), fontsize=12, fontweight="bold", ha="left")

        for pos in BLUE_BACK + BLUE_FRONT + RED_FRONT + RED_BACK:
            draw_unit(ax, pos, is_active=(active_pos == pos))

        arrows = arrows or []
        for a in arrows:
            draw_attack_arrow(ax, a["src"], a["dst"], a["team"],
                              text=a.get("text"),
                              style=a.get("style","solid"),
                              color=a.get("color"),
                              alpha=a.get("alpha",0.95),
                              curve=a.get("curve",0.18),
                              lw=a.get("lw",2.6))

        if headline:
            ax.text(0.5, 0.52, headline[:120], fontsize=12, ha="center", va="bottom", color=(0.15,0.15,0.15))

        fig.canvas.draw(); handle.update(fig)

    # --- –Ω–∞—á–∞–ª—å–Ω—ã–π –∫–∞–¥—Ä
    current_actor_pos = None
    draw_board(headline="–ù–∞—á–∞–ª–æ –±–æ—è", active_pos=current_actor_pos)

    last_selection = None  # dict: {"src":pos, "dst":pos, "team":"BLUE"/"RED"}

    for line in all_logs:
        arrows_now = []
        headline = ""

        # —Å–º–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —é–Ω–∏—Ç–∞
        m = blue_turn_re.match(line)
        if m:
            current_actor_pos = int(m.group(1))
            headline = line
            draw_board(arrows_now, headline, active_pos=current_actor_pos); time.sleep((FRAME_DELAY * VISUAL_SPEED_MULT) / 1.05); continue

        m = red_turn_re.match(line)
        if m:
            current_actor_pos = int(m.group(1))
            headline = line
            draw_board(arrows_now, headline, active_pos=current_actor_pos); time.sleep((FRAME_DELAY * VISUAL_SPEED_MULT) / 1.05); continue

        # —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –∞—Ç–∞–∫–∞ —Å —É—Ä–æ–Ω–æ–º
        m = atk_re.match(line)
        if m:
            atk_team = m.group(1)
            atk_pos  = int(m.group(2))
            vic_pos  = int(m.group(4))
            dmg      = int(m.group(5))
            after    = int(m.group(7))
            if vic_pos in state:
                state[vic_pos]["hp"] = after
            current_actor_pos = atk_pos
            arrows_now.append({"src": atk_pos, "dst": vic_pos, "team": atk_team, "text": f"-{dmg}"})
            headline = line
            draw_board(arrows_now, headline, active_pos=current_actor_pos); time.sleep(FRAME_DELAY * VISUAL_SPEED_MULT); continue

        # —Ç–∏–∫–∏ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
        m = poison_tick_re.match(line)
        if m:
            vic_pos = int(m.group(2)); after = int(m.group(5))
            if vic_pos in state: state[vic_pos]["hp"] = after
            headline = line
            draw_board([], headline, active_pos=current_actor_pos); time.sleep((FRAME_DELAY * VISUAL_SPEED_MULT) / 1.2); continue

        m = burn_tick_re.match(line)
        if m:
            vic_pos = int(m.group(2)); after = int(m.group(5))
            if vic_pos in state: state[vic_pos]["hp"] = after
            headline = line
            draw_board([], headline, active_pos=current_actor_pos); time.sleep((FRAME_DELAY * VISUAL_SPEED_MULT) / 1.2); continue

        # –≤—ã–±–æ—Ä —Ü–µ–ª–∏ (—Ç–æ–Ω–∫–∞—è –ø—É–Ω–∫—Ç–∏—Ä–Ω–∞—è —Å—Ç—Ä–µ–ª–∫–∞-–Ω–∞–º–µ—Ä–µ–Ω–∏–µ)
        m = blue_action_re.match(line)
        if m:
            src = int(m.group(1)); dst = int(m.group(2))
            last_selection = {"src": src, "dst": dst, "team": "BLUE"}
            current_actor_pos = src
            arrows_now.append({"src": src, "dst": dst, "team": "BLUE",
                               "style":"dashed", "alpha":0.65, "lw":2.0})
            headline = line
            draw_board(arrows_now, headline, active_pos=current_actor_pos); time.sleep((FRAME_DELAY * VISUAL_SPEED_MULT) / 1.1); continue

        m = red_target_re.match(line)
        if m:
            src = int(m.group(1)); dst = int(m.group(2))
            last_selection = {"src": src, "dst": dst, "team": "RED"}
            current_actor_pos = src
            arrows_now.append({"src": src, "dst": dst, "team": "RED",
                               "style":"dashed", "alpha":0.65, "lw":2.0})
            headline = line
            draw_board(arrows_now, headline, active_pos=current_actor_pos); time.sleep((FRAME_DELAY * VISUAL_SPEED_MULT) / 1.1); continue

        # –∏–º–º—É–Ω–∏—Ç–µ—Ç –∫ —É—Ä–æ–Ω—É / —Å—Ç–∞—Ç—É—Å—É ‚Äî —Å–µ—Ä–∞—è —Å—Ç—Ä–µ–ª–∫–∞ –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤—ã–±–æ—Ä–∞
        if immune_dmg_re.match(line) or immune_stat_re.match(line):
            if last_selection:
                arrows_now.append({"src": last_selection["src"], "dst": last_selection["dst"],
                                   "team": last_selection["team"], "color": (0.45,0.45,0.45),
                                   "style":"solid", "alpha":0.9, "text":"IMMUNE"})
                current_actor_pos = last_selection["src"]
            headline = line
            draw_board(arrows_now, headline, active_pos=current_actor_pos); time.sleep((FRAME_DELAY * VISUAL_SPEED_MULT) / 1.2); continue

        # –Ω–µ–¥–æ—Å—è–≥–∞–µ–º–∞—è —Ü–µ–ª—å ‚Äî –ø—É–Ω–∫—Ç–∏—Ä–Ω–∞—è —Å–µ—Ä–∞—è
        m = blue_cant_re.match(line)
        if m:
            src = int(m.group(1)); dst = int(m.group(2))
            arrows_now.append({"src": src, "dst": dst, "team": "BLUE",
                               "color": (0.5,0.5,0.5), "style":"dashed", "alpha":0.9, "text":"–Ω–µ–¥–æ—Å—è–≥–∞–µ–º–æ"})
            current_actor_pos = src
            headline = line
            draw_board(arrows_now, headline, active_pos=current_actor_pos); time.sleep((FRAME_DELAY * VISUAL_SPEED_MULT) / 1.2); continue

        # –ü–†–û–ú–ê–• ‚Äî —Å–µ—Ä–∞—è —Å—Ç—Ä–µ–ª–∫–∞ —Å –ø–æ–¥–ø–∏—Å—å—é MISS
        m = miss_re.match(line)
        if m:
            atk_team = m.group(1)
            atk_pos  = int(m.group(2))
            vic_team = m.group(3)
            vic_pos  = int(m.group(4))
            current_actor_pos = atk_pos
            arrows_now.append({"src": atk_pos, "dst": vic_pos, "team": atk_team,
                               "color": (0.5,0.5,0.5), "style":"solid", "alpha":0.9, "text":"MISS"})
            headline = line
            draw_board(arrows_now, headline, active_pos=current_actor_pos); time.sleep((FRAME_DELAY * VISUAL_SPEED_MULT) / 1.15); continue

        # —É–±–∏–π—Å—Ç–≤–æ
        m = kill_re.match(line)
        if m:
            pos = int(m.group(2))
            if pos in state: state[pos]["hp"] = 0
            headline = line
            draw_board([], headline, active_pos=current_actor_pos); time.sleep((FRAME_DELAY * VISUAL_SPEED_MULT) / 1.1); continue

        # –±–∞–Ω–Ω–µ—Ä –º–∞—Å—Å–æ–≤–æ–π –∞—Ç–∞–∫–∏ (Mage/Dead dragon) ‚Äî –±–µ–∑ —Å—Ç—Ä–µ–ª–æ–∫
        if mage_banner_re.match(line):
            headline = line
            draw_board([], headline, active_pos=current_actor_pos); time.sleep((FRAME_DELAY * VISUAL_SPEED_MULT) / 1.1); continue

        # –ø–æ–±–µ–¥–∞
        if vict_re.match(line):
            headline = line
            current_actor_pos = None
            draw_board([], headline, active_pos=current_actor_pos); time.sleep(FRAME_DELAY * VISUAL_SPEED_MULT); continue

        # –ø—Ä–æ—á–∏–µ —Å—Ç—Ä–æ–∫–∏ ‚Äî –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞–¥—Ä
        draw_board([], line, active_pos=current_actor_pos); time.sleep((FRAME_DELAY * VISUAL_SPEED_MULT) / 1.2)

    draw_board([], "–ö–æ–Ω–µ—Ü —ç–ø–∏–∑–æ–¥–∞", active_pos=None)
    time.sleep(0.6 * VISUAL_SPEED_MULT)
