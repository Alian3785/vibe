# ======================== –ò–ú–ü–û–†–¢–´ ===========================
# –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ Python
import os
import re
import time
import shutil
import random
from operator import itemgetter

# –ù–∞—É—á–Ω—ã–π —Å—Ç–µ–∫
import numpy as np

# Gymnasium (—Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –≤–µ—Ç–∫–∞ OpenAI Gym)
import gymnasium as gym
from gymnasium import spaces

# ====================== –ò–°–•–û–î–ù–´–ï –î–ê–ù–ù–´–ï =====================
# –í —ç—Ç–æ–º –±–ª–æ–∫–µ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–æ—Å—Ç–∞–≤ –¥–≤—É—Ö –∫–æ–º–∞–Ω–¥ –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –±–æ—è.
# –ü–æ —É—Å–ª–æ–≤–∏—é 12 —é–Ω–∏—Ç–æ–≤: RED (–ø–æ–∑–∏—Ü–∏–∏ 1..6), BLUE (–ø–æ–∑–∏—Ü–∏–∏ 7..12).
# –í—Å–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã: –£—Ä–æ–Ω=20, –ó–¥–æ—Ä–æ–≤—å–µ=60.
# –ò–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ—Ä—è–¥–æ–∫ —Ö–æ–¥–∞ –≤ —Ä–∞—É–Ω–¥–µ.

UNITS_RED = [
    {"–∏–º—è": "—Ä—ã—Ü–∞—Ä—å1",  "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞": 67, "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞_–±–∞–∑–∞": 67, "team": "red",  "position": 1, "stand": "ahead",  "Type": "Archer", "–£—Ä–æ–Ω": 20, "–ó–¥–æ—Ä–æ–≤—å–µ": 60},
    {"–∏–º—è": "—Ä—ã—Ü–∞—Ä—å2",  "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞": 33, "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞_–±–∞–∑–∞": 33, "team": "red",  "position": 2, "stand": "ahead",  "Type": "Archer", "–£—Ä–æ–Ω": 20, "–ó–¥–æ—Ä–æ–≤—å–µ": 60},
    {"–∏–º—è": "—Ä—ã—Ü–∞—Ä—å3",  "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞": 78, "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞_–±–∞–∑–∞": 78, "team": "red",  "position": 3, "stand": "ahead",  "Type": "Archer", "–£—Ä–æ–Ω": 20, "–ó–¥–æ—Ä–æ–≤—å–µ": 60},
    {"–∏–º—è": "—Ä—ã—Ü–∞—Ä—å7",  "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞": 45, "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞_–±–∞–∑–∞": 45, "team": "red",  "position": 4, "stand": "behind", "Type": "Archer", "–£—Ä–æ–Ω": 20, "–ó–¥–æ—Ä–æ–≤—å–µ": 60},
    {"–∏–º—è": "—Ä—ã—Ü–∞—Ä—å8",  "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞": 90, "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞_–±–∞–∑–∞": 90, "team": "red",  "position": 5, "stand": "behind", "Type": "Archer", "–£—Ä–æ–Ω": 20, "–ó–¥–æ—Ä–æ–≤—å–µ": 60},
    {"–∏–º—è": "—Ä—ã—Ü–∞—Ä—å9",  "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞": 12, "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞_–±–∞–∑–∞": 12, "team": "red",  "position": 6, "stand": "behind", "Type": "Archer", "–£—Ä–æ–Ω": 20, "–ó–¥–æ—Ä–æ–≤—å–µ": 60},
]


UNITS_BLUE = [
    {"–∏–º—è": "—Ä—ã—Ü–∞—Ä—å4",  "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞": 88, "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞_–±–∞–∑–∞": 88, "team": "blue", "position": 7,  "stand": "ahead",  "Type": "Archer", "–£—Ä–æ–Ω": 20, "–ó–¥–æ—Ä–æ–≤—å–µ": 60},
    {"–∏–º—è": "—Ä—ã—Ü–∞—Ä—å5",  "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞": 55, "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞_–±–∞–∑–∞": 55, "team": "blue", "position": 8,  "stand": "ahead",  "Type": "Archer", "–£—Ä–æ–Ω": 20, "–ó–¥–æ—Ä–æ–≤—å–µ": 60},
    {"–∏–º—è": "—Ä—ã—Ü–∞—Ä—å6",  "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞": 22, "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞_–±–∞–∑–∞": 22, "team": "blue", "position": 9,  "stand": "ahead",  "Type": "Archer", "–£—Ä–æ–Ω": 20, "–ó–¥–æ—Ä–æ–≤—å–µ": 60},
    {"–∏–º—è": "—Ä—ã—Ü–∞—Ä—å10", "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞": 60, "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞_–±–∞–∑–∞": 60, "team": "blue", "position": 10, "stand": "behind", "Type": "Archer", "–£—Ä–æ–Ω": 20, "–ó–¥–æ—Ä–æ–≤—å–µ": 60},
    {"–∏–º—è": "—Ä—ã—Ü–∞—Ä—å11", "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞": 47, "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞_–±–∞–∑–∞": 47, "team": "blue", "position": 11, "stand": "behind", "Type": "Archer", "–£—Ä–æ–Ω": 20, "–ó–¥–æ—Ä–æ–≤—å–µ": 60},
    {"–∏–º—è": "—Ä—ã—Ü–∞—Ä—å12", "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞": 75, "–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞_–±–∞–∑–∞": 75, "team": "blue", "position": 12, "stand": "behind", "Type": "Archer", "–£—Ä–æ–Ω": 20, "–ó–¥–æ—Ä–æ–≤—å–µ": 60},
]

# –î–≤–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –ø–æ–∑–∏—Ü–∏–π: RED (1..6) –∏ BLUE (7..12)
RED_POSITIONS  = list(range(1, 7))
BLUE_POSITIONS = list(range(7, 13))

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫
MAX_HP   = 60
MAX_INIT = max([u["–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞_–±–∞–∑–∞"] for u in (UNITS_RED + UNITS_BLUE)])

# ==================== –ö–õ–ê–°–° –°–†–ï–î–´ GYMNASIUM ==================
class BattleEnv(gym.Env):
    """
    –ö–ê–°–¢–û–ú–ù–ê–Ø –°–†–ï–î–ê ¬´RED vs BLUE¬ª –î–õ–Ø RL

    –ù–∞–±–ª—é–¥–µ–Ω–∏–µ (obs):
        –í–µ–∫—Ç–æ—Ä –¥–ª–∏–Ω—ã 24 (float32) = –ø–æ 2 –ø—Ä–∏–∑–Ω–∞–∫–∞ –Ω–∞ –∫–∞–∂–¥—É—é –∏–∑ 12 –ø–æ–∑–∏—Ü–∏–π:
        [HP1, INI1, HP2, INI2, ..., HP12, INI12]
        –ü–æ—Ä—è–¥–æ–∫ –ø–æ–∑–∏—Ü–∏–π —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π: —Å–Ω–∞—á–∞–ª–∞ 1..6 (RED), –∑–∞—Ç–µ–º 7..12 (BLUE).

    –î–µ–π—Å—Ç–≤–∏–µ (action):
        Discrete(6) ‚Äî –∏–Ω–¥–µ–∫—Å 0..5 -> —É–¥–∞—Ä –ø–æ –ø–æ–∑–∏—Ü–∏–∏ RED_POSITIONS[action], —Ç.–µ. –ø–æ –ø–æ–∑–∏—Ü–∏—è–º 1..6.

    –ü–æ—Ä—è–¥–æ–∫ —Ö–æ–¥–æ–≤:
        ‚Äî –í–Ω—É—Ç—Ä–∏ —Ä–∞—É–Ω–¥–∞ —Ö–æ–¥—è—Ç –ø–æ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–µ (—á–µ–º –≤—ã—à–µ, —Ç–µ–º —Ä–∞–Ω—å—à–µ).
        ‚Äî –ö–∞–∫ —Ç–æ–ª—å–∫–æ —é–Ω–∏—Ç —Å—Ö–æ–¥–∏–ª –≤ —Ç–µ–∫—É—â–µ–º —Ä–∞—É–Ω–¥–µ, –µ–≥–æ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞ –æ–±–Ω—É–ª—è–µ—Ç—Å—è (–≤ —ç—Ç–æ–º —Ä–∞—É–Ω–¥–µ –æ–Ω –±–æ–ª—å—à–µ –Ω–µ —Ö–æ–¥–∏—Ç).
        ‚Äî –ö–æ–≥–¥–∞ —É –≤—Å–µ—Ö –∂–∏–≤—ã—Ö –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞ = 0, –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π —Ä–∞—É–Ω–¥, –∏ –∂–∏–≤—ã–º –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –¥–æ –±–∞–∑–æ–≤–æ–π.

    –õ–æ–≥–∏–∫–∞ —Å—Ç–æ—Ä–æ–Ω:
        ‚Äî BLUE (–∞–≥–µ–Ω—Ç): –∫–æ–≥–¥–∞ –ø–æ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–µ –¥–æ—Ö–æ–¥–∏—Ç –æ—á–µ—Ä–µ–¥—å –∂–∏–≤–æ–≥–æ —Å–∏–Ω–µ–≥–æ —é–Ω–∏—Ç–∞, —Å—Ä–µ–¥–∞ ¬´–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è¬ª,
          –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ –∏ –∂–¥—ë—Ç –¥–µ–π—Å—Ç–≤–∏–µ –∞–≥–µ–Ω—Ç–∞ (–≤—ã–±–æ—Ä RED-—Ü–µ–ª–∏). –ó–∞—Ç–µ–º –ø—Ä–∏–º–µ–Ω—è–µ—Ç —É–¥–∞—Ä –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–±–µ–¥—É.
        ‚Äî RED (–ø—Ä–æ—Ç–∏–≤–Ω–∏–∫): –Ω–∞ —Å–≤–æ—ë–º —Ö–æ–¥—É –≤—ã–±–∏—Ä–∞–µ—Ç –°–õ–£–ß–ê–ô–ù–£–Æ –∂–∏–≤—É—é —Ü–µ–ª—å —Å—Ä–µ–¥–∏ BLUE –∏ –∞—Ç–∞–∫—É–µ—Ç –µ—ë.

    –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —ç–ø–∏–∑–æ–¥–∞:
        ‚Äî –°—Ä–∞–∑—É –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —É–¥–∞—Ä–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, –æ—Å—Ç–∞–ª–∏—Å—å –ª–∏ –∂–∏–≤—ã–µ —É –æ–±–µ–∏—Ö —Å—Ç–æ—Ä–æ–Ω.
        ‚Äî –ö–∞–∫ —Ç–æ–ª—å–∫–æ —É —Å—Ç–æ—Ä–æ–Ω—ã –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å –∂–∏–≤—ã—Ö ‚Äî —ç–ø–∏–∑–æ–¥ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ–Ω (terminated=True).

    –í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ:
        ‚Äî –í –ø—Ä–æ—Ü–µ—Å—Å–µ: 0 (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é).
        ‚Äî –ü–æ–±–µ–¥–∞ BLUE: +1.
        ‚Äî –ü–æ–±–µ–¥–∞ RED : -1.
    """

    metadata = {"render_modes": []}

    def __init__(self, reward_win: float = 1.0, reward_loss: float = -1.0, reward_step: float = 0.0,
                 log_enabled: bool = False):
        """
        :param reward_win:   –Ω–∞–≥—Ä–∞–¥–∞ –∑–∞ –ø–æ–±–µ–¥—É BLUE
        :param reward_loss:  –Ω–∞–≥—Ä–∞–¥–∞ –∑–∞ –ø–æ—Ä–∞–∂–µ–Ω–∏–µ BLUE
        :param reward_step:  –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞ –∑–∞ —à–∞–≥ (shaping), –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 0
        :param log_enabled:  –≤–∫–ª—é—á–∏—Ç—å —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–µ –ª–æ–≥–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞ —Ç–µ—Å—Ç–µ)
        """
        super().__init__()
        # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞–≥—Ä–∞–¥
        self.reward_win  = float(reward_win)
        self.reward_loss = float(reward_loss)
        self.reward_step = float(reward_step)

        # –§–ª–∞–≥ –ª–æ–≥–∞ –¥–ª—è —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø—Ä–æ–≥–æ–Ω–∞)
        self.log_enabled = bool(log_enabled)

        # –ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –¥–µ–π—Å—Ç–≤–∏–π: –≤—ã–±–æ—Ä —Ü–µ–ª–µ–≤–æ–π –ø–æ–∑–∏—Ü–∏–∏ —Å—Ä–µ–¥–∏ 6 –∫—Ä–∞—Å–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤
        self.action_space = spaces.Discrete(6)

        # –ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π: 24 float32 (HP –∏ INI –Ω–∞ 12 –ø–æ–∑–∏—Ü–∏—è—Ö)
        low  = np.zeros(24, dtype=np.float32)
        high = np.array(sum([[MAX_HP, MAX_INIT] for _ in range(12)], []), dtype=np.float32)
        self.observation_space = spaces.Box(low=low, high=high, dtype=np.float32)

        # –ì–°–ß –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç–∏ (–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ seed())
        self.rng = random.Random()

        # –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–æ—è
        self.combined = None                   # —Å–ø–∏—Å–æ–∫ –∏–∑ 12 dict-—é–Ω–∏—Ç–æ–≤ (–∫–æ–ø–∏–∏ –∏—Å—Ö–æ–¥–Ω—ã—Ö)
        self.round_no = None                   # –Ω–æ–º–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ —Ä–∞—É–Ω–¥–∞
        self.winner = None                     # "red" | "blue" | None
        self.current_blue_attacker_pos = None  # –ø–æ–∑–∏—Ü–∏—è —Å–∏–Ω–µ–≥–æ, –∫–æ—Ç–æ—Ä—ã–π –∂–¥—ë—Ç –¥–µ–π—Å—Ç–≤–∏–µ –∞–≥–µ–Ω—Ç–∞

        # –ë—É—Ñ–µ—Ä —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã—Ö –ª–æ–≥–æ–≤ (—Å—Ç—Ä–æ–∫–∏), –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ log_enabled=True
        self._pretty_events = []

    # ------------------ –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –ú–ï–¢–û–î–´ ------------------

    def seed(self, seed=None):
        """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å seed –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ —Å–ª—É—á–∞–π–Ω—ã—Ö —á–∏—Å–µ–ª (–≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç—å)."""
        self.rng = random.Random(seed)

    def _alive(self, u) -> bool:
        """–í–µ—Ä–Ω—É—Ç—å True, –µ—Å–ª–∏ —é–Ω–∏—Ç –∂–∏–≤ (HP > 0)."""
        return u["–ó–¥–æ—Ä–æ–≤—å–µ"] > 0

    def _team_alive(self, team: str) -> bool:
        """–ï—Å—Ç—å –ª–∏ —É –∫–æ–º–∞–Ω–¥—ã team —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∂–∏–≤–æ–π —é–Ω–∏—Ç."""
        return any(self._alive(u) and u["team"] == team for u in self.combined)

    def _unit_by_position(self, pos: int):
        """–í–µ—Ä–Ω—É—Ç—å —Å–ª–æ–≤–∞—Ä—å-—é–Ω–∏—Ç –ø–æ –ø–æ–∑–∏—Ü–∏–∏ pos (1..12), –ª–∏–±–æ None, –µ—Å–ª–∏ –ø—É—Å—Ç–æ."""
        return next((u for u in self.combined if u["position"] == pos), None)

    def _live_positions_of(self, team: str):
        """–í–µ—Ä–Ω—É—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–∑–∏—Ü–∏–π –∂–∏–≤—ã—Ö —é–Ω–∏—Ç–æ–≤ —É–∫–∞–∑–∞–Ω–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã."""
        return [u["position"] for u in self.combined if u["team"] == team and self._alive(u)]

    def _log(self, s: str):
        """–î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É –≤ —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–π –ª–æ–≥ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ —Ç–µ—Å—Ç–æ–≤–æ–º –ø—Ä–æ–≥–æ–Ω–µ)."""
        if self.log_enabled:
            self._pretty_events.append(s)

    def pop_pretty_events(self):
        """
        –ó–∞–±—Ä–∞—Ç—å –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ –ª–æ–≥–∏ –∏ –æ—á–∏—Å—Ç–∏—Ç—å –±—É—Ñ–µ—Ä.
        –£–¥–æ–±–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ reset()/step(), —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å ¬´–∫–∞–¥—Ä¬ª –ª–æ–≥–æ–≤.
        """
        out = self._pretty_events[:]
        self._pretty_events.clear()
        return out

    def _reset_state(self):
        """
        –ü–æ–ª–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —ç–ø–∏–∑–æ–¥–∞:
        ‚Äî –ö–ª–æ–Ω–∏—Ä—É–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ —Å–ª–æ–≤–∞—Ä–∏ —é–Ω–∏—Ç–æ–≤ (—á—Ç–æ–±—ã –Ω–µ –º—É—Ç–∏—Ä–æ–≤–∞—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–µ).
        ‚Äî –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É —Ä–∞–≤–Ω–æ–π –±–∞–∑–æ–≤–æ–π.
        ‚Äî –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥–∏: –Ω–æ–º–µ—Ä —Ä–∞—É–Ω–¥–∞, –ø–æ–±–µ–¥–∏—Ç–µ–ª—å, ¬´–æ–∂–∏–¥–∞—é—â–∏–π BLUE¬ª.
        """
        # –£ RED –∑–∞—Ä–∞–Ω–µ–µ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–ª–∏ –∫–ª—é—á–∏, —É BLUE –≤—Å—ë –æ–∫
        self.combined = [u.copy() for u in (UNITS_RED + UNITS_BLUE)]
        for u in self.combined:
            u["–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞"] = u["–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞_–±–∞–∑–∞"]
        self.round_no = 1
        self.winner = None
        self.current_blue_attacker_pos = None
        self._log(f"–≠–ø–∏–∑–æ–¥ –Ω–∞—á–∞—Ç. –†–∞—É–Ω–¥ {self.round_no}.")

    def _candidates(self):
        """
        –í–µ—Ä–Ω—É—Ç—å —Å–ø–∏—Å–æ–∫ —é–Ω–∏—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç —Ö–æ–¥–∏—Ç—å –≤ —Ç–µ–∫—É—â–µ–º —Ä–∞—É–Ω–¥–µ:
        ‚Äî —é–Ω–∏—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∂–∏–≤, –∏
        ‚Äî –µ–≥–æ —Ç–µ–∫—É—â–∞—è –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å > 0.
        """
        return [u for u in self.combined if self._alive(u) and u["–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞"] > 0]

    def _pop_next(self):
        """
        –í—ã–±–æ—Ä —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ö–æ–¥—è—â–µ–≥–æ:
        1) –ë–µ—Ä—ë–º –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ (–∂–∏–≤—ã–µ, INI>0).
        2) –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º (—Ä–µ—à–∞–µ–º –Ω–∏—á—å–∏ –ø–æ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–µ —Å–ª—É—á–∞–π–Ω–æ).
        3) –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–µ –ø–æ —É–±—ã–≤–∞–Ω–∏—é.
        4) –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤–µ—Ä—Ö–Ω–µ–≥–æ.
        –ï—Å–ª–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –Ω–µ—Ç ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º None (–∫–æ–Ω–µ—Ü —Ä–∞—É–Ω–¥–∞).
        """
        cand = self._candidates()
        if not cand:
            return None
        self.rng.shuffle(cand)
        cand.sort(key=itemgetter("–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞"), reverse=True)
        return cand[0]

    def _end_round_restore(self):
        """
        –ö–æ–Ω–µ—Ü —Ä–∞—É–Ω–¥–∞: –≤—Å–µ–º –ñ–ò–í–´–ú –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É –∫ –±–∞–∑–æ–≤–æ–π (–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞_–±–∞–∑–∞),
        –º—ë—Ä—Ç–≤—ã–º –æ—Å—Ç–∞–≤–ª—è–µ–º 0. –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ —Ä–∞—É–Ω–¥–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å–Ω–∞—Ä—É–∂–∏.
        """
        for u in self.combined:
            u["–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞"] = u["–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞_–±–∞–∑–∞"] if self._alive(u) else 0
        self._log("–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã. –ù–æ–≤—ã–π —Ä–∞—É–Ω–¥.")

    # ------------------- –£–î–ê–† –ò –ü–†–û–í–ï–†–ö–ê –ü–û–ë–ï–î–´ -------------------

    def _attack(self, attacker, target_pos: int):
        """
        –í—ã–ø–æ–ª–Ω–∏—Ç—å –∞—Ç–∞–∫—É ¬´attacker¬ª –ø–æ –ø–æ–∑–∏—Ü–∏–∏ target_pos:
        ‚Äî –ï—Å–ª–∏ –≤ —Ü–µ–ª–µ–≤–æ–π –ø–æ–∑–∏—Ü–∏–∏ –µ—Å—Ç—å –∂–∏–≤–æ–π —é–Ω–∏—Ç, –æ—Ç–Ω–∏–º–∞–µ–º —É –Ω–µ–≥–æ HP –Ω–∞ –≤–µ–ª–∏—á–∏–Ω—É –£—Ä–æ–Ω (20).
        ‚Äî –ï—Å–ª–∏ –ø–æ—Å–ª–µ —É–¥–∞—Ä–∞ HP <= 0, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É –∂–µ—Ä—Ç–≤—ã (–≤ —ç—Ç–æ–º —Ä–∞—É–Ω–¥–µ –æ–Ω–∞ —É–∂–µ –Ω–µ —Å—Ö–æ–¥–∏—Ç—Å—è).
        ‚Äî –ü–∏—à–µ–º —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—É—é –∑–∞–ø–∏—Å—å (–µ—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω –ª–æ–≥).
        """
        victim = self._unit_by_position(target_pos) if target_pos is not None else None
        if victim is not None and self._alive(victim):
            before = victim["–ó–¥–æ—Ä–æ–≤—å–µ"]
            victim["–ó–¥–æ—Ä–æ–≤—å–µ"] -= attacker["–£—Ä–æ–Ω"]
            after = victim["–ó–¥–æ—Ä–æ–≤—å–µ"]
            self._log(f"{attacker['team'].upper()} {attacker['–∏–º—è']}#{attacker['position']} ‚Üí "
                      f"{victim['team'].upper()} {victim['–∏–º—è']}#{victim['position']}: {attacker['–£—Ä–æ–Ω']} "
                      f"({before}‚Üí{max(0, after)})")
            if victim["–ó–¥–æ—Ä–æ–≤—å–µ"] <= 0:
                victim["–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞"] = 0
                self._log(f"‚úñ {victim['team'].upper()} {victim['–∏–º—è']}#{victim['position']} –≤—ã–≤–µ–¥–µ–Ω –∏–∑ —Å—Ç—Ä–æ—è.")
        else:
            self._log(f"{attacker['team'].upper()} {attacker['–∏–º—è']}#{attacker['position']} –±—å—ë—Ç pos{target_pos}: —Ü–µ–ª–∏ –Ω–µ—Ç/–º–µ—Ä—Ç–≤–∞.")

    def _check_victory_after_hit(self):
        """
        –°—Ä–∞–∑—É –ø–æ—Å–ª–µ –ª—é–±–æ–≥–æ —É–¥–∞—Ä–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Å—Ç–∞–ª–∏—Å—å –ª–∏ –∂–∏–≤—ã–µ —É –æ–±–µ–∏—Ö —Å—Ç–æ—Ä–æ–Ω.
        –ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∂–∏–≤—ã—Ö —É –æ–¥–Ω–æ–π –∏–∑ —Å—Ç–æ—Ä–æ–Ω ‚Äî —Ñ–∏–∫—Å–∏—Ä—É–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –∏ –ª–æ–≥–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏–µ.
        """
        if not self._team_alive("blue"):
            self.winner = "red"
            self._log("üèÜ –ü–æ–±–µ–¥–∞ RED!")
        elif not self._team_alive("red"):
            self.winner = "blue"
            self._log("üèÜ –ü–æ–±–µ–¥–∞ BLUE!")

    # --------------- –ê–í–¢–û–î–û–ö–†–£–¢–ö–ê –î–û –•–û–î–ê BLUE ----------------

    def _advance_until_blue_turn(self) -> bool:
        """
        –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –±–æ–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –ø–æ–∫–∞ –Ω–µ –Ω–∞—Å—Ç—É–ø–∏—Ç –æ—á–µ—Ä–µ–¥—å –∂–∏–≤–æ–≥–æ BLUE,
        –∏–ª–∏ –ø–æ–∫–∞ –±–æ–π –Ω–µ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è.
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
            True  ‚Äî –µ—Å–ª–∏ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å –Ω–∞ —Ö–æ–¥—É BLUE (—Å—Ä–µ–¥–∞ –∂–¥—ë—Ç –¥–µ–π—Å—Ç–≤–∏–µ –∞–≥–µ–Ω—Ç–∞),
            False ‚Äî –µ—Å–ª–∏ –±–æ–π –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –¥–æ —ç—Ç–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞.
        –í–Ω—É—Ç—Ä–∏:
          ‚Äî –ï—Å–ª–∏ –Ω–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –Ω–∞ —Ö–æ–¥ ‚Üí –∫–æ–Ω–µ—Ü —Ä–∞—É–Ω–¥–∞: –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É –∏ –Ω–∞—á–∞—Ç—å –Ω–æ–≤—ã–π.
          ‚Äî –ï—Å–ª–∏ —Ö–æ–¥ RED ‚Üí –≤—ã–±—Ä–∞—Ç—å —Å–ª—É—á–∞–π–Ω—É—é –∂–∏–≤—É—é —Ü–µ–ª—å —Å—Ä–µ–¥–∏ BLUE –∏ –∞—Ç–∞–∫–æ–≤–∞—Ç—å.
          ‚Äî –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —É–¥–∞—Ä–∞ ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è.
        """
        while self._team_alive("red") and self._team_alive("blue"):
            nxt = self._pop_next()
            if nxt is None:
                # –í—Å–µ –∂–∏–≤—ã–µ —É–∂–µ —Å—Ö–æ–¥–∏–ª–∏ ‚Äî –Ω–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—ã–π —Ä–∞—É–Ω–¥
                self._log(f"‚Äî –ö–æ–Ω–µ—Ü —Ä–∞—É–Ω–¥–∞ {self.round_no}.")
                self._end_round_restore()
                self.round_no += 1
                self._log(f"‚Äî –ù–∞—á–∞–ª–æ —Ä–∞—É–Ω–¥–∞ {self.round_no}.")
                continue

            if nxt["team"] == "blue":
                # –ü—Ä–∏—à—ë–ª —Ö–æ–¥ –∂–∏–≤–æ–≥–æ BLUE ‚Äî –≤—ã—Ö–æ–¥–∏–º –∏ –∂–¥—ë–º action –æ—Ç –∞–≥–µ–Ω—Ç–∞
                self.current_blue_attacker_pos = nxt["position"]
                self._log(f"–•–æ–¥ BLUE: {nxt['–∏–º—è']}#{nxt['position']} (–∏–Ω–∏—Ü {nxt['–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞']}). –û–∂–∏–¥–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è.")
                return True

            # === –•–æ–¥ RED (–ø—Ä–æ—Ç–∏–≤–Ω–∏–∫): —Å–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä –∂–∏–≤–æ–π —Ü–µ–ª–∏ —Å—Ä–µ–¥–∏ BLUE ===
            nxt["–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞"] = 0  # –≤ —Ä–∞–º–∫–∞—Ö —Ç–µ–∫—É—â–µ–≥–æ —Ä–∞—É–Ω–¥–∞ —ç—Ç–æ—Ç —é–Ω–∏—Ç —Å—Ö–æ–¥–∏–ª
            live_blue_positions = self._live_positions_of("blue")
            target_pos = self.rng.choice(live_blue_positions) if live_blue_positions else None
            self._log(f"RED —Ö–æ–¥: {nxt['–∏–º—è']}#{nxt['position']} ‚Üí —Å–ª—É—á–∞–π–Ω–∞—è —Ü–µ–ª—å pos{target_pos}.")
            self._attack(nxt, target_pos)
            self._check_victory_after_hit()
            if self.winner is not None:
                return False

        # –ë–æ–µ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å –¥–æ –æ—á–µ—Ä–µ–¥–∏ BLUE
        return False

    # -------------------- –ù–ê–ë–õ–Æ–î–ï–ù–ò–ï –î–õ–Ø –ê–ì–ï–ù–¢–ê --------------------

    def _obs(self) -> np.ndarray:
        """
        –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ: –ø–ª–æ—Å–∫–∏–π –≤–µ–∫—Ç–æ—Ä (24,) = [HP, INI] –¥–ª—è pos=1..12.
        –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (–Ω–µ –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–ª—è—Ç—å—Å—è) –æ–±—Ä–µ–∑–∞–µ–º –¥–æ –Ω—É–ª—è –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏.
        """
        vec = []
        for pos in RED_POSITIONS + BLUE_POSITIONS:
            u = self._unit_by_position(pos)
            vec.extend([float(max(0, u["–ó–¥–æ—Ä–æ–≤—å–µ"])), float(max(0, u["–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞"]))])
        return np.array(vec, dtype=np.float32)

    # ------------------------ API GYMNASIUM ------------------------

    def reset(self, *, seed=None, options=None):
        """
        –°–±—Ä–æ—Å —ç–ø–∏–∑–æ–¥–∞:
          1) –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–æ—è.
          2) –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–∫—Ä—É—á–∏–≤–∞–µ–º –¥–æ –ø–µ—Ä–≤–æ–≥–æ —Ö–æ–¥–∞ BLUE (–∏–ª–∏ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞).
          3) –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ –∏ –ø—É—Å—Ç–æ–π info (–ø–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É Gymnasium).
        """
        if seed is not None:
            self.seed(seed)
        self._reset_state()
        self._advance_until_blue_turn()
        return self._obs(), {}

    def step(self, action):
        """
        –û–¥–∏–Ω —à–∞–≥ —Å—Ä–µ–¥—ã:
          ‚Äî –ï—Å–ª–∏ –≤–¥—Ä—É–≥ —Å–µ–π—á–∞—Å –Ω–µ –æ—á–µ—Ä–µ–¥—å BLUE, –¥–æ–∫—Ä—É—á–∏–≤–∞–µ–º –¥–æ BLUE (–∏–ª–∏ –∑–∞–≤–µ—Ä—à–∞–µ–º, –µ—Å–ª–∏ –±–æ–π —É–∂–µ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è).
          ‚Äî –ö–æ–≥–¥–∞ –æ—á–µ—Ä–µ–¥—å BLUE: –±–µ—Ä—ë–º –ø–æ–∑–∏—Ü–∏—é –∞—Ç–∞–∫—É—é—â–µ–≥–æ BLUE –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º –¥–µ–π—Å—Ç–≤–∏–µ –∞–≥–µ–Ω—Ç–∞:
                target_pos = RED_POSITIONS[action]  (—É–¥–∞—Ä –ø–æ –æ–¥–Ω–æ–π –∏–∑ 6 –∫—Ä–∞—Å–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π)
            –ü–æ—Å–ª–µ —É–¥–∞—Ä–∞ —Å—Ä–∞–∑—É –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è.
          ‚Äî –ï—Å–ª–∏ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –Ω–µ—Ç ‚Äî —Å–Ω–æ–≤–∞ –¥–æ–∫—Ä—É—á–∏–≤–∞–µ–º –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ BLUE (–º–µ–∂–¥—É –¥–µ–ª–æ–º —Ö–æ–¥—è—Ç RED –ø–æ —Å–≤–æ–µ–π –ø–æ–ª–∏—Ç–∏–∫–µ).
          ‚Äî –í–æ–∑–≤—Ä–∞—â–∞–µ–º (obs, reward, terminated, truncated, info).
        –ù–∞–≥—Ä–∞–¥–∞:
          ‚Äî 0, –µ—Å–ª–∏ –±–æ–π –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è;
          ‚Äî +1, –µ—Å–ª–∏ –ø–æ–±–µ–¥–∏–ª BLUE;
          ‚Äî -1, –µ—Å–ª–∏ –ø–æ–±–µ–¥–∏–ª RED.
        """
        # –ï—Å–ª–∏ —ç–ø–∏–∑–æ–¥ —É–∂–µ –∑–∞–≤–µ—Ä—à—ë–Ω ‚Äî –ø—Ä–æ—Å–∏–º –≤—ã–∑–≤–∞—Ç—å reset()
        assert self.winner is None, "–≠–ø–∏–∑–æ–¥ –∑–∞–≤–µ—Ä—à—ë–Ω ‚Äî –≤—ã–∑–æ–≤–∏—Ç–µ reset()."

        # –ü–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞: –µ—Å–ª–∏ –Ω–µ –æ—á–µ—Ä–µ–¥—å BLUE, –¥–æ–∫—Ä—É—Ç–∏–º –¥–æ –µ–≥–æ —Ö–æ–¥–∞
        if self.current_blue_attacker_pos is None:
            self._advance_until_blue_turn()
            if self.winner is not None:
                # –ë–æ–π –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –µ—â—ë –¥–æ —Ö–æ–¥–∞ BLUE
                return self._obs(), (self.reward_win if self.winner == "blue" else self.reward_loss), True, False, {}

        # === –•–û–î BLUE (–∞–≥–µ–Ω—Ç) ===
        target_pos = RED_POSITIONS[int(action)]          # –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –∏–Ω–¥–µ–∫—Å –¥–µ–π—Å—Ç–≤–∏—è –≤ —Ä–µ–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
        attacker   = self._unit_by_position(self.current_blue_attacker_pos)
        if attacker is not None and self._alive(attacker) and attacker["–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞"] > 0:
            self._log(f"BLUE –¥–µ–π—Å—Ç–≤–∏–µ: {attacker['–∏–º—è']}#{attacker['position']} ‚Üí pos{target_pos}")
            attacker["–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞"] = 0                   # –≤ —ç—Ç–æ–º —Ä–∞—É–Ω–¥–µ —Å–∏–Ω–∏–π —É–∂–µ —Å—Ö–æ–¥–∏–ª
            self._attack(attacker, target_pos)          # –ø—Ä–∏–º–µ–Ω—è–µ–º —É—Ä–æ–Ω
            self._check_victory_after_hit()             # –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è

        # –ï—Å–ª–∏ –±–æ–π –Ω–µ –∑–∞–≤–µ—Ä—à—ë–Ω ‚Äî –¥–æ–∫—Ä—É—Ç–∫–∞ –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ BLUE (RED –±—É–¥–µ—Ç —Ö–æ–¥–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
        if self.winner is None:
            self.current_blue_attacker_pos = None
            self._advance_until_blue_turn()

        # –§–∏–Ω–∞–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞
        if self.winner is None:
            reward, terminated = self.reward_step, False
        else:
            reward  = self.reward_win if self.winner == "blue" else self.reward_loss
            terminated = True

        return self._obs(), reward, terminated, False, {}

# =================== –û–ë–£–ß–ï–ù–ò–ï PPO + W&B =====================
if __name__ == "__main__":
    # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º Stable-Baselines3 –∏ –∫–æ–ª–±—ç–∫–∏ –ø—Ä—è–º–æ –≤–Ω—É—Ç—Ä–∏ main-–±–ª–æ–∫–∞ (—á—Ç–æ–±—ã –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –º–æ–¥—É–ª—è –æ–Ω–∏ –Ω–µ —Ç—Ä–µ–±–æ–≤–∞–ª–∏—Å—å)
    from stable_baselines3 import PPO
    from stable_baselines3.common.env_util import make_vec_env
    from stable_baselines3.common.monitor import Monitor
    from stable_baselines3.common.callbacks import CallbackList, EvalCallback

    # Weights & Biases –¥–ª—è —Ç—Ä–µ–∫–∏–Ω–≥–∞ –æ–±—É—á–µ–Ω–∏—è
    import wandb
    from wandb.integration.sb3 import WandbCallback

    # ---------------- –ü–ê–†–ê–ú–ï–¢–†–´ –û–ë–£–ß–ï–ù–ò–Ø ----------------
    TOTAL_STEPS   = 300_000   # —Å–∫–æ–ª—å–∫–æ —à–∞–≥–æ–≤ —Å—Ä–µ–¥—ã —Å–¥–µ–ª–∞–µ—Ç PPO (—Å—É–º–º–∞—Ä–Ω–æ –ø–æ –≤—Å–µ–º –≤–µ–∫—Ç–æ—Ä–Ω—ã–º –∫–æ–ø–∏—è–º)
    N_ENVS        = 8        # —Å–∫–æ–ª—å–∫–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∫–æ–ø–∏–π —Å—Ä–µ–¥—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
    VISUALIZE_TEST = True    # –≤–∫–ª—é—á–∏—Ç—å –ª–∏ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∞
    FRAME_DELAY    = 0.28    # –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É ¬´–∫–∞–¥—Ä–∞–º–∏¬ª –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ (—Å–µ–∫)
    USE_COLOR      = True    # —Ü–≤–µ—Ç–Ω—ã–µ ANSI –≤ –∫–æ–Ω—Å–æ–ª–∏ (–µ—Å–ª–∏ —Ç–µ—Ä–º–∏–Ω–∞–ª –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç)

    # ------------- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø W&B –õ–û–ì–ê --------------
    # –ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Å–¥–µ–ª–∞–π—Ç–µ wandb.login() –æ–¥–∏–Ω —Ä–∞–∑ –≤ —Å–∏—Å—Ç–µ–º–µ/—Å–µ—Å—Å–∏–∏.
    run = wandb.init(
        project="red-blue-battle",           # –ø–æ–º–µ–Ω—è–π—Ç–µ –Ω–∞ –≤–∞—à –ø—Ä–æ–µ–∫—Ç –≤ W&B
        name=f"ppo-{TOTAL_STEPS//1000}k",    # –∏–º—è –∑–∞–ø—É—Å–∫–∞
        config={                             # –ø–æ–ª–µ–∑–Ω—ã–µ –≥–∏–ø–µ—Ä–ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ W&B
            "algo": "PPO",
            "total_timesteps": TOTAL_STEPS,
            "n_envs": N_ENVS,
            "n_steps": 1024,
            "batch_size": 2048,
            "gamma": 0.99,
            "gae_lambda": 0.95,
            "learning_rate": 3e-4,
            "clip_range": 0.2,
        },
        sync_tensorboard=True,               # —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–∫–∞–ª—è—Ä–æ–≤ TensorBoard ‚Üí W&B
        save_code=True,                      # –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –∫–æ–¥ –∫ –∑–∞–ø—É—Å–∫—É
    )

    # -------- –§–ê–ë–†–ò–ö–ê –°–†–ï–î –î–õ–Ø –í–ï–ö–¢–û–†–ò–ó–ê–¶–ò–ò --------
    def make_env():
        # –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º —Å—Ä–µ–¥—É –≤ Monitor, —á—Ç–æ–±—ã SB3 —Å—á–∏—Ç–∞–ª —ç–ø–∏–∑–æ–¥–∏—á–µ—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏ (ep_rew_mean –∏ —Ç.–ø.)
        return Monitor(BattleEnv(reward_win=1.0, reward_loss=-1.0, reward_step=0.0, log_enabled=False))

    # –í–µ–∫—Ç–æ—Ä–Ω–∞—è —Å—Ä–µ–¥–∞: N_ENVS –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∫–æ–ø–∏–π –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–Ω–æ–≥–æ —Å–±–æ—Ä–∞ –æ–ø—ã—Ç–∞
    vec_env = make_vec_env(make_env, n_envs=N_ENVS, seed=42)

    # –û—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ä–µ–¥–∞ –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π –æ—Ü–µ–Ω–∫–∏ (EvalCallback)
    eval_env = Monitor(BattleEnv(log_enabled=False))

    # --------------- –ù–ê–°–¢–†–û–ô–ö–ê –ú–û–î–ï–õ–ò PPO ---------------
    model = PPO(
        policy="MlpPolicy",
        env=vec_env,
        verbose=1,                         # –ø–µ—á–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –æ–±—É—á–µ–Ω–∏—è SB3
        n_steps=1024,                      # –¥–ª–∏–Ω–∞ rollout –Ω–∞ –ö–ê–ñ–î–£–Æ —Å—Ä–µ–¥—É (–∏—Ç–æ–≥–æ N_ENVS * n_steps —à–∞–≥–æ–≤ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)
        batch_size=2048,                   # —Ä–∞–∑–º–µ—Ä –º–∏–Ω–∏-–±–∞—Ç—á–∞ SGD (–¥–æ–ª–∂–µ–Ω –¥–µ–ª–∏—Ç—å—Å—è –Ω–∞ N_ENVS*n_steps / n_epochs)
        gae_lambda=0.95,
        gamma=0.99,
        n_epochs=10,
        learning_rate=3e-4,
        clip_range=0.2,
        ent_coef=0.0,
        vf_coef=0.5,
        seed=42,
        tensorboard_log=f"./tb_logs/{run.id}",  # –∫—É–¥–∞ –ø–∏—Å–∞—Ç—å TB-–ª–æ–≥–∏ (W&B –∏—Ö –ø–æ–¥—Ö–≤–∞—Ç–∏—Ç)
    )

    # –ö–æ–ª–±—ç–∫ W&B: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–≤/–º–æ–¥–µ–ª–∏ –∏ —Å–∏–Ω–∫ –º–µ—Ç—Ä–∏–∫
    wandb_cb = WandbCallback(
        gradient_save_freq=1000,                     # –∫–∞–∫ —á–∞—Å—Ç–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≥—Ä–∞–¥–∏–µ–Ω—Ç—ã (–º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏)
        model_save_path=f"./models/{run.id}",        # –∫—É–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —á–µ–∫–ø–æ–∏–Ω—Ç—ã
        model_save_freq=10_000,                      # –ø–µ—Ä–∏–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–æ–¥–µ–ª–∏
        verbose=2,
    )

    # –ö–æ–ª–±—ç–∫ –æ—Ü–µ–Ω–∫–∏: –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –∑–∞–º–µ—Ä—è–µ–º —Å—Ä–µ–¥–Ω—é—é –Ω–∞–≥—Ä–∞–¥—É –Ω–∞ eval_env
    eval_cb = EvalCallback(
        eval_env,
        best_model_save_path=f"./models/{run.id}/best",
        log_path=f"./eval/{run.id}",
        eval_freq=10_000,               # –∫–∞–∂–¥—ã–µ 10k —à–∞–≥–æ–≤
        n_eval_episodes=5,
        deterministic=True,
        render=False,
    )

    # –ó–∞–ø—É—Å–∫ –æ–±—É—á–µ–Ω–∏—è —Å –∫–æ–ª–±—ç–∫–∞–º–∏ (W&B + eval)
    model.learn(total_timesteps=TOTAL_STEPS, callback=CallbackList([wandb_cb, eval_cb]))

    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –º–æ–¥–µ–ª–∏
    model.save("ppo_blue_vs_red")
    run.finish()  # –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º W&B-–∑–∞–ø—É—Å–∫

    # ================= –¢–ï–°–¢–û–í–´–ô –ü–†–û–ì–û–ù –° –õ–û–ì–ê–ú–ò =================
    print("\n=== –¢–ï–°–¢–û–í–´–ô –ü–†–û–ì–û–ù –° –õ–û–ì–ê–ú–ò ===")
    test_env = BattleEnv(log_enabled=True)      # –≤–∫–ª—é—á–∞–µ–º —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–µ –ª–æ–≥–∏ —Ç–æ–ª—å–∫–æ –Ω–∞ —Ç–µ—Å—Ç–µ
    obs, info = test_env.reset(seed=123)

    # –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–æ–≤ (–±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã –∏ –¥–ª—è –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏)
    all_logs = []
    all_logs += test_env.pop_pretty_events()    # –ª–æ–≥–∏, –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ –≤–æ –≤—Ä–µ–º—è reset()/–∞–≤—Ç–æ–¥–æ–∫—Ä—É—Ç–∫–∏

    done = False
    total_reward = 0.0
    step_i = 0
    while not done:
        step_i += 1
        action, _ = model.predict(obs, deterministic=True)  # –≤ —Ç–µ—Å—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—É—é –ø–æ–ª–∏—Ç–∏–∫—É
        target_pos = RED_POSITIONS[int(action)]
        chosen_line = f"[STEP {step_i}] –ê–≥–µ–Ω—Ç –≤—ã–±–∏—Ä–∞–µ—Ç action={int(action)} ‚Üí –∞—Ç–∞–∫–∞ RED pos{target_pos}"
        print("\n" + chosen_line)
        all_logs.append(chosen_line)

        obs, reward, terminated, truncated, info = test_env.step(action)
        total_reward += reward
        done = terminated or truncated

        # –ü–µ—á–∞—Ç–∞–µ–º –ª–æ–≥–∏ —Ç–µ–∫—É—â–µ–≥–æ —à–∞–≥–∞ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∏—Ö –≤ –æ–±—â–∏–π —Å–ø–∏—Å–æ–∫
        new_lines = test_env.pop_pretty_events()
        all_logs += new_lines
        for line in new_lines:
            print(line)

    print("\n=== –≠–ü–ò–ó–û–î –ó–ê–í–ï–†–®–Å–ù ===")
    print("–ü–æ–±–µ–¥–∏—Ç–µ–ª—å:", test_env.winner.upper(), "| –°—É–º–º–∞—Ä–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞:", total_reward)

    # ============== –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø –ü–û –õ–û–ì–ê–ú (matplotlib, –∫–∞–∫ –≤ checkpointchek) ==============
    # –ë–æ–ª–µ–µ –Ω–∞–≥–ª—è–¥–Ω–∞—è –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è –∞–Ω–∏–º–∞—Ü–∏—è, —Ä–∞–∑–±–∏—Ä–∞—é—â–∞—è —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–æ–≤ –∏ —Ä–∏—Å—É—é—â–∞—è –ø–æ–ª–µ –±–æ—è.
    if VISUALIZE_TEST:
        import math
        import matplotlib.pyplot as plt
        from matplotlib import patches
        from matplotlib.patches import FancyArrowPatch
        try:
            from IPython.display import display
        except Exception:
            display = None

        VISUAL_SPEED_MULT = 8.0

        # --- —Å–µ—Ç–∫–∞ –ø–æ–ª—è
        RED_FRONT, RED_BACK   = [1,2,3],   [4,5,6]
        BLUE_FRONT, BLUE_BACK = [7,8,9],   [10,11,12]
        COL_X = {0: 0.18, 1: 0.50, 2: 0.82}
        Y_BLUE_BACK, Y_BLUE_FRONT = 0.88, 0.70
        Y_RED_FRONT,  Y_RED_BACK  = 0.30, 0.12
        SLOT_W, SLOT_H = 0.28, 0.13
        HP_H = 0.028

        # --- —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–∏–º–µ–Ω–∞ –∏ —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ HP)
        state = {u["position"]: {"team": u["team"], "name": u["–∏–º—è"], "hp": float(u["–ó–¥–æ—Ä–æ–≤—å–µ"]), "maxhp": float(u["–ó–¥–æ—Ä–æ–≤—å–µ"]) }
                 for u in (UNITS_RED + UNITS_BLUE)}

        fig, ax = plt.subplots(figsize=(12, 8))
        handle = None
        IS_NOTEBOOK = False
        if display is not None:
            try:
                handle = display(fig, display_id=True)
                IS_NOTEBOOK = handle is not None
            except Exception:
                handle = None
                IS_NOTEBOOK = False
        if IS_NOTEBOOK:
            plt.close(fig)
        else:
            plt.ion()
            try:
                fig.show()
            except Exception:
                pass

        def pos_to_xy(pos: int):
            col = (pos - 1) % 3
            x = COL_X[col] - SLOT_W/2
            if pos in BLUE_BACK:   y = Y_BLUE_BACK  - SLOT_H/2
            elif pos in BLUE_FRONT:y = Y_BLUE_FRONT - SLOT_H/2
            elif pos in RED_FRONT: y = Y_RED_FRONT  - SLOT_H/2
            else:                  y = Y_RED_BACK   - SLOT_H/2
            return x, y

        def pos_center(pos: int):
            x, y = pos_to_xy(pos)
            return x + SLOT_W/2, y + SLOT_H/2

        def draw_unit(ax, pos, is_active: bool = False):
            u = state[pos]; x, y = pos_to_xy(pos)
            # –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–¥–Ω–∏–π —Ä—è–¥ –º—ë—Ä—Ç–≤—ã—Ö (—á—Ç–æ–±—ã –Ω–µ –∑–∞–≥—Ä–æ–º–æ–∂–¥–∞—Ç—å)
            if pos in (RED_BACK + BLUE_BACK) and u["hp"] <= 0:
                return
            card_color = (0.90, 0.30, 0.30, 0.16) if u["team"] == "red" else (0.30, 0.45, 0.90, 0.16)
            ax.add_patch(patches.FancyBboxPatch((x, y), SLOT_W, SLOT_H,
                                                boxstyle="round,pad=0.010,rounding_size=0.016",
                                                linewidth=1.3, edgecolor="black", facecolor=card_color))
            if is_active:
                ax.add_patch(patches.FancyBboxPatch(
                    (x-0.01, y-0.01), SLOT_W+0.02, SLOT_H+0.02,
                    boxstyle="round,pad=0.012,rounding_size=0.018",
                    linewidth=3.0, edgecolor=(1.0, 0.82, 0.10), facecolor='none', alpha=0.95
                ))
            name = u["name"][:22]
            ax.text(x + 0.012, y + SLOT_H*0.78, name,
                    fontsize=10, fontweight="bold", ha="left", va="center", color="black")

            hp_x, hp_y = x + 0.012, y + SLOT_H*0.10
            hp_w = SLOT_W - 0.024
            ax.add_patch(patches.Rectangle((hp_x, hp_y), hp_w, HP_H, facecolor=(0.88,0.88,0.88), edgecolor='none'))
            frac = max(0.0, min(1.0, u["hp"]/u["maxhp"])) if u["maxhp"] > 1e-9 else 0.0
            ax.add_patch(patches.Rectangle((hp_x, hp_y), hp_w*frac, HP_H, facecolor=(0.15,0.70,0.25), edgecolor='none'))
            ax.text(hp_x + hp_w/2, hp_y + HP_H/2, f"{int(max(0,u['hp']))}/{int(u['maxhp'])}",
                    fontsize=9, ha="center", va="center", color="black")

            ax.text(x + SLOT_W/2, y - 0.008, f"pos{pos}", fontsize=8, ha="center", va="top", color=(0.2,0.2,0.2))

        def draw_attack_arrow(ax, src_pos:int, dst_pos:int, team:str,
                              text: str|None = None, style: str = "solid",
                              color: tuple|None = None, alpha: float = 0.95,
                              curve: float = 0.18, lw: float = 2.6):
            sx, sy = pos_center(src_pos)
            dx, dy = pos_center(dst_pos)
            vx, vy = dx - sx, dy - sy
            dist = math.hypot(vx, vy) + 1e-9
            pad = 0.06
            sx += vx/dist * pad; sy += vy/dist * pad
            dx -= vx/dist * pad; dy -= vy/dist * pad
            if color is None:
                color = (0.20, 0.35, 0.85) if team == "BLUE" else (0.85, 0.25, 0.25)
            con_style = f"arc3,rad={curve}" if abs(vx) > 0.01 and abs(vy) > 0.01 else "arc3,rad=0.0"
            arrow = FancyArrowPatch((sx, sy), (dx, dy), arrowstyle="-|>",
                                    mutation_scale=14, linewidth=lw,
                                    linestyle="--" if style=="dashed" else "solid",
                                    color=color, alpha=alpha, connectionstyle=con_style)
            ax.add_patch(arrow)
            if text:
                mx, my = (sx + dx)/2, (sy + dy)/2
                ax.text(mx, my + 0.03, text, fontsize=10, fontweight="bold",
                        ha="center", va="center", color=color)

        # --- —Ä–µ–≥–µ–∫—Å—ã (—Å–æ–≤–º–µ—Å—Ç–∏–º—ã —Å —Ç–µ–∫—É—â–∏–º–∏ –ª–æ–≥–∞–º–∏ simpleenv)
        atk_re         = re.compile(r'^(RED|BLUE)\s+[^#]+#(\d+)\s+‚Üí\s+(RED|BLUE)\s+[^#]+#(\d+):\s+(\d+)\s+\((\d+)‚Üí(\d+)\)')
        kill_re        = re.compile(r'^‚úñ\s+(RED|BLUE)\s+[^#]+#(\d+)\s+–≤—ã–≤–µ–¥–µ–Ω –∏–∑ —Å—Ç—Ä–æ—è\.')
        vict_re        = re.compile(r'^üèÜ –ü–æ–±–µ–¥–∞ (RED|BLUE)!')
        blue_turn_re   = re.compile(r'^–•–æ–¥ BLUE:\s+[^#]+#(\d+)')
        red_turn_re    = re.compile(r'^RED —Ö–æ–¥:\s+[^#]+#(\d+)')
        blue_action_re = re.compile(r'^BLUE –¥–µ–π—Å—Ç–≤–∏–µ:\s+[^#]+#(\d+)\s+‚Üí\s+pos(\d+)')

        def draw_board(arrows: list[dict] = None, headline: str = "", active_pos: int | None = None):
            ax.cla()
            ax.set_xlim(0, 1); ax.set_ylim(0, 1); ax.axis("off")
            ax.plot([0.02, 0.98], [0.50, 0.50], color=(0.6,0.6,0.6), lw=1.2, ls="--", alpha=0.7)
            ax.text(0.01, 0.96, "BLUE (top)", color=(0.2,0.35,0.8), fontsize=12, fontweight="bold", ha="left")
            ax.text(0.01, 0.04, "RED (bottom)", color=(0.8,0.25,0.25), fontsize=12, fontweight="bold", ha="left")

            arrows = arrows or []
            for pos in (BLUE_BACK + BLUE_FRONT + RED_FRONT + RED_BACK):
                draw_unit(ax, pos, is_active=(active_pos == pos))

            for a in arrows:
                draw_attack_arrow(ax, a["src"], a["dst"], a["team"],
                                  text=a.get("text"), style=a.get("style","solid"),
                                  color=a.get("color"), alpha=a.get("alpha",0.95),
                                  curve=a.get("curve",0.18), lw=a.get("lw",2.6))

            if headline:
                ax.text(0.5, 0.52, headline[:140], fontsize=12, ha="center", va="bottom", color=(0.15,0.15,0.15))

            fig.canvas.draw()
            if handle is not None:
                handle.update(fig)
            else:
                plt.draw(); plt.pause(0.001)

        # --- –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–µ–º –ª–æ–≥–∏ –ø–æ–∫–∞–¥—Ä–æ–≤–æ
        current_actor_pos = None
        draw_board(headline="–ù–∞—á–∞–ª–æ –±–æ—è", active_pos=current_actor_pos)

        last_selection = None
        for line in all_logs:
            arrows_now = []
            headline = ""

            m = blue_turn_re.match(line)
            if m:
                current_actor_pos = int(m.group(1))
                headline = line
                draw_board(arrows_now, headline, active_pos=current_actor_pos); time.sleep((FRAME_DELAY * VISUAL_SPEED_MULT) / 1.05); continue

            m = red_turn_re.match(line)
            if m:
                current_actor_pos = int(m.group(1))
                headline = line
                draw_board(arrows_now, headline, active_pos=current_actor_pos); time.sleep((FRAME_DELAY * VISUAL_SPEED_MULT) / 1.05); continue

            m = atk_re.match(line)
            if m:
                atk_team = m.group(1); atk_pos = int(m.group(2))
                vic_pos = int(m.group(4)); dmg = int(m.group(5)); after = int(m.group(7))
                if vic_pos in state: state[vic_pos]["hp"] = after
                current_actor_pos = atk_pos
                arrows_now.append({"src": atk_pos, "dst": vic_pos, "team": atk_team, "text": f"-{dmg}"})
                headline = line
                draw_board(arrows_now, headline, active_pos=current_actor_pos); time.sleep(FRAME_DELAY * VISUAL_SPEED_MULT); continue

            m = blue_action_re.match(line)
            if m:
                src = int(m.group(1)); dst = int(m.group(2))
                last_selection = {"src": src, "dst": dst, "team": "BLUE"}
                current_actor_pos = src
                arrows_now.append({"src": src, "dst": dst, "team": "BLUE",
                                   "style":"dashed", "alpha":0.65, "lw":2.0})
                headline = line
                draw_board(arrows_now, headline, active_pos=current_actor_pos); time.sleep((FRAME_DELAY * VISUAL_SPEED_MULT) / 1.1); continue

            m = kill_re.match(line)
            if m:
                pos = int(m.group(2))
                if pos in state: state[pos]["hp"] = 0
                headline = line
                draw_board([], headline, active_pos=current_actor_pos); time.sleep((FRAME_DELAY * VISUAL_SPEED_MULT) / 1.1); continue

            if vict_re.match(line) or line.startswith("‚Äî ") or "RED —Ö–æ–¥" in line:
                headline = line
                draw_board([], headline, active_pos=current_actor_pos); time.sleep((FRAME_DELAY * VISUAL_SPEED_MULT) / 1.1); continue

            # –ü—Ä–æ—á–∏–µ —Å—Ç—Ä–æ–∫–∏
            draw_board([], line, active_pos=current_actor_pos); time.sleep((FRAME_DELAY * VISUAL_SPEED_MULT) / 1.2)

        draw_board([], "–ö–æ–Ω–µ—Ü —ç–ø–∏–∑–æ–¥–∞", active_pos=None)
